	
/*
Copyright (c) 2001, 2015 Alpha Software Corporation
All Rights Reserved.

This JavaScript library is licensed exclusively for use with Alpha Anywhere, Alpha Five,
Alpha Five Application Server, Alpha Anywhere Application Server,
Alpha Five Run Engine, and Alpha Anywhere Run Engine. It is specifically
not licensed for use on a server that does not have installed on it a
licensed copy of the Alpha Five Application Server or the Alpha Anywhere Application Server.

Portions:
(c) Copyright 2010- 2015 Software Garden, Inc.
All Rights Reserved.
*/



A5.ink={_:{pageLines:{'signature':{defaults:{size:120,margin:20,x:{show:true,color:'#000',width:5,ratio:.75,margin:30},baseLine:{show:true,color:'#000',width:1},background:'',text:{show:false,data:'',size:60,margin:5,color:'#000',fontFamily:'Arial'}},navigate:function(d,r,s){return d;},draw:function(r,s,c){var svg='';var hm=Math.round(s.margin*r.scale);var vm=Math.round(((r.height-s.size-$if(s.text.show,s.text.size+s.text.margin,0))*r.scale)/2);var rh=Math.round((s.size*r.scale));var rw=Math.round((r.width*r.scale)-(hm*2));var xl=(r.x*r.scale)+hm;var xr=xl+rw;var yt=(r.y*r.scale)+vm;var yb=yt+rh;if(s.background!=''){if(c){c.fillStyle=s.background;c.fillRect(xl,yt,rw,rh);}else{svg+='<rect x="'+xl+'" y="'+yt+'" width="'+rw+'" height="'+rh+'" style="stroke: none; fill: '+s.background+';" />';}}
if(s.baseLine.show){var sWidth=Math.max(1,s.baseLine.width*r.scale);if(c){c.strokeStyle=s.baseLine.color;c.lineWidth=sWidth;c.lineCap='butt';c.beginPath();c.moveTo(xl,yb);c.lineTo(xr,yb);c.stroke();c.closePath()}else{svg+='<path d="M '+xl+' '+yb+' L '+xr+' '+yb+'" style="stroke: '+s.baseLine.color+'; stroke-width: '+sWidth+'; stroke-linecap: butt;" />';}}
if(s.x.show){var xoff=(s.x.margin*r.scale);var xh=Math.round(rh-(xoff*2));var xw=Math.round(xh*s.x.ratio);var xxl=xl+xoff;var xxr=xxl+xw;var xyt=yt+xoff;var xyb=xyt+xh;var sWidth=Math.max(1,s.x.width*r.scale);if(c){c.strokeStyle=s.x.color;c.lineWidth=sWidth;c.lineCap='round';c.beginPath();c.moveTo(xxl,xyt);c.lineTo(xxr,xyb);c.stroke();c.moveTo(xxl,xyb);c.lineTo(xxr,xyt);c.stroke();c.closePath()}else{svg+='<path d="M '+xxl+' '+xyt+' L '+xxr+' '+xyb+'" style="stroke: '+s.x.color+'; stroke-width: '+sWidth+'; stroke-linecap: round;" />';svg+='<path d="M '+xxl+' '+xyb+' L '+xxr+' '+xyt+'" style="stroke: '+s.x.color+'; stroke-width: '+sWidth+'; stroke-linecap: round;" />';}}
if(s.text.show){var tyt=yb+((s.text.size+s.text.margin)*r.scale);var txt=s.text.data;if(txt[0]=='@'){txt=txt.substr(1);txt=txt.split('||');var altTxt=txt[1]||'';txt=txt[0];txt=txt.split('.');var d=this.meta;while(txt.length>0){if(typeof d[txt[0]]!='undefined'){d=d[txt[0]];txt.shift();}else{d=altTxt;break;}}
if(typeof d=='string'&&d!='')txt=d;else txt=altTxt;}
if(c){c.font=(s.text.size*r.scale)+'px '+s.text.fontFamily;c.fillStyle=s.text.color;c.fillText(txt,xl,tyt);}else{svg+='<text x="'+xl+'" y="'+tyt+'" style="fill: '+s.text.color+'; stroke: none; font: '+(s.text.size*r.scale)+'px '+s.text.fontFamily+'">'+txt+'</text>';}}
return svg;}},'graph':{defaults:{style:'normal',color:'#c7c7c7',width:1,size:120,minor:0,margin:{top:0,left:0,right:0,bottom:0,adjust:true}},navigate:function(d,r,s){if(d=='forward')return'right';else if(d=='back')return'left';else if(d=='start')return{x:0,y:0};else if(d=='end')return{x:r.width,y:r.height};else if(d=='line-start')return{x:0,y:r.y};else if(d=='line-end')return{x:r.width,y:r.y};else if(d=='new-line')return{x:0,y:r.y+s.size};else if(d=='prev-line')return{x:r.x,y:r.y-s.size};else if(d=='next-line')return{x:r.x,y:r.y+s.size};},draw:function(r,s,c){if(!r.editing&&s.style[0]=='e')return'';var cs=s.size*r.scale;var csm=0;if(s.minor>0){csm=cs/s.minor;if(csm>4)csm=csm;else csm=0;}
if(s.margin.adjust){var hm=((r.width*r.scale)-(Math.floor((((r.width-s.margin.left-s.margin.right)*r.scale))/cs)*cs))/2;var vm=((r.height*r.scale)-(Math.floor((((r.height-s.margin.top-s.margin.bottom)*r.scale))/cs)*cs))/2;var xl=Math.floor((r.x*r.scale)+hm);var xr=Math.ceil(((r.x+r.width)*r.scale)-hm);var yt=Math.floor((r.y*r.scale)+vm);var yb=Math.ceil(((r.y+r.height)*r.scale)-vm);}else{var xl=Math.floor(((r.x+s.margin.left)*r.scale));var xr=Math.ceil(((r.x-s.margin.right+r.width)*r.scale));var yt=Math.floor(((r.y+s.margin.top)*r.scale));var yb=Math.ceil(((r.y-s.margin.bottom+r.height)*r.scale));}
var svg='';var sWidth=Math.max(1,s.width*r.scale);if(csm>0){if(c){c.strokeStyle=s.color;c.lineWidth=sWidth;c.lineCap='square';c.globalAlpha=.5;}else{svg+='<g style="stroke-width: '+sWidth+'; stroke-linecap: square;"><g style="stroke: '+s.color+'; stroke-opacity: .5;">';}
var lc=0;var cx=xl;var start=xl;while(cx<=xr){if(lc!=0){if(c){c.beginPath();c.moveTo(cx,yt);c.lineTo(cx,yb);c.stroke();c.closePath()}else{svg+='<path d="M '+cx+' '+yb+' L '+cx+' '+yb+'" />';}}
lc++;if(lc==s.minor){lc=0;start+=cs;cx=start;}else cx+=csm;}
lc=0;var cy=yt;start=yt;while(cy<=yb){if(lc!=0){if(c){c.beginPath();c.moveTo(xl,cy);c.lineTo(xr,cy);c.stroke();c.closePath()}else{svg+='<path d="M '+xl+' '+cy+' L '+xr+' '+cy+'" />';}}
lc++;if(lc==s.minor){lc=0;start+=cs;cy=start;}else cy+=csm;}
if(!c)svg+='</g>';}
if(c){c.strokeStyle=s.color;c.lineWidth=sWidth;c.lineCap='square';c.globalAlpha=1;}else{svg+='<g style="stroke-width: '+sWidth+'; stroke-linecap: square;"><g style="stroke: '+s.color+';">';}
var cx=xl;while(cx<=xr){if(c){c.beginPath();c.moveTo(cx,yt);c.lineTo(cx,yb);c.stroke();c.closePath()}else{svg+='<path d="M '+cx+' '+yb+' L '+cx+' '+yb+'" />';}
cx+=cs;}
var cy=yt;while(cy<=yb){if(c){c.beginPath();c.moveTo(xl,cy);c.lineTo(xr,cy);c.stroke();c.closePath()}else{svg+='<path d="M '+xl+' '+cy+' L '+xr+' '+cy+'" />';}
cy+=cs;}
if(!s.margin.adjust){if(c){c.beginPath();c.moveTo(xl,yt);c.lineTo(xr,yt);c.stroke();c.closePath()
c.beginPath();c.moveTo(xl,yb);c.lineTo(xr,yb);c.stroke();c.closePath()
c.beginPath();c.moveTo(xl,yt);c.lineTo(xl,yb);c.stroke();c.closePath()
c.beginPath();c.moveTo(xr,yt);c.lineTo(xr,yb);c.stroke();c.closePath()}else{svg+='<path d="M '+xl+' '+yt+' L '+xr+' '+yt+'" />';svg+='<path d="M '+xl+' '+yb+' L '+xr+' '+yb+'" />';svg+='<path d="M '+xl+' '+yt+' L '+xl+' '+yb+'" />';svg+='<path d="M '+xr+' '+yt+' L '+xr+' '+yb+'" />';}}
if(!c)svg+='</g>';return svg;}},'ruled':{defaults:{flow:'ltr',style:'normal',width:1,margin:{color:'#f98a6e',top:120,left:120,right:120,bottom:120},rules:{color:'#c7c7c7',size:120}},navigate:function(d,r,s){if(s.flow=='ltr'||s.flow=='rtl'){var rOff=0;if(r.clip.height>s.rules.size*2)rOff=s.rules.size/2;else if(r.clip.height>s.rules.size*1.5)rOff=s.rules.size/3;var cLine=Math.floor(((r.y+s.rules.size)-s.margin.top-1)/s.rules.size);var lLine=Math.floor((r.height-s.margin.top-s.margin.bottom)/s.rules.size)-1;if(s.flow=='ltr'){if(d=='forward')return'right';else if(d=='back')return'left';else if(d=='start')return{x:0,y:s.margin.top+s.rules.size+rOff-r.clip.height};else if(d=='end')return{x:r.width,y:s.margin.top+(lLine*s.rules.size)-rOff};else if(d=='line-start')return{x:0,y:s.margin.top+(cLine*s.rules.size)-rOff};else if(d=='line-end')return{x:r.width,y:s.margin.top+(cLine*s.rules.size)-rOff};else if(d=='new-line')return{x:0,y:s.margin.top+(Math.min(cLine+1,lLine)*s.rules.size)-rOff};}else{if(d=='forward')return'left';else if(d=='back')return'right';else if(d=='start')return{x:r.width,y:s.margin.top+s.rules.size+rOff-r.clip.height};else if(d=='end')return{x:0,y:s.margin.top+(lLine*s.rules.size)-rOff};else if(d=='line-start')return{x:r.width,y:s.margin.top+(cLine*s.rules.size)-rOff};else if(d=='line-end')return{x:0,y:s.margin.top+(cLine*s.rules.size)-rOff};else if(d=='new-line')return{x:r.width,y:s.margin.top+(Math.min(cLine+1,lLine)*s.rules.size)-rOff};}
if(d=='prev-line')return{x:r.x,y:s.margin.top+(Math.max(cLine-1,0)*s.rules.size)-rOff};else if(d=='next-line')return{x:r.x,y:s.margin.top+(Math.min(cLine+1,lLine)*s.rules.size)-rOff};}else if(s.flow=='ttb-ltr'){var rOff=0;if(r.clip.width>s.rules.size*2)rOff=s.rules.size/2;else if(r.clip.width>s.rules.size*1.5)rOff=s.rules.size/3;var cLine=Math.floor(((r.x+s.rules.size)-s.margin.left-1)/s.rules.size);var lLine=Math.floor((r.width-s.margin.left-s.margin.right)/s.rules.size)-1;if(d=='forward')return'down';else if(d=='back')return'up';else if(d=='start')return{x:s.margin.left+s.rules.size+rOff-r.clip.width,y:0};else if(d=='end')return{x:s.margin.left+(lLine*s.rules.size)-rOff,y:r.height};else if(d=='line-start')return{x:s.margin.left+(cLine*s.rules.size)-rOff,y:0};else if(d=='line-end')return{x:s.margin.left+(cLine*s.rules.size)-rOff,y:r.height};else if(d=='new-line')return{x:s.margin.left+(Math.min(cLine+1,lLine)*s.rules.size)-rOff,y:0};else if(d=='prev-line')return{x:s.margin.left+(Math.max(cLine-1,0)*s.rules.size)-rOff,y:r.y};else if(d=='next-line')return{x:s.margin.left+(Math.min(cLine+1,lLine)*s.rules.size)-rOff,y:r.y};}else if(s.flow=='ttb-ltr'||s.flow=='ttb-rtl'){var rOff=0;if(r.clip.width>s.rules.size*2)rOff=s.rules.size/2;else if(r.clip.width>s.rules.size*1.5)rOff=s.rules.size/3;var cLine=Math.floor(((r.x+s.rules.size)-s.margin.left-1)/s.rules.size)-1;var lLine=Math.floor((r.width-s.margin.left-s.margin.right)/s.rules.size)-1;var fOff=r.width-((lLine+1)*s.rules.size)-s.margin.left-s.margin.right;if(d=='forward')return'down';else if(d=='back')return'up';else if(d=='start')return{x:s.margin.left+(lLine*s.rules.size)-rOff+fOff,y:0};else if(d=='end')return{x:s.margin.left+s.rules.size+rOff-r.clip.width+fOff,y:r.height};else if(d=='line-start')return{x:s.margin.left+(cLine*s.rules.size)-rOff+fOff,y:0};else if(d=='line-end')return{x:s.margin.left+(cLine*s.rules.size)-rOff+fOff,y:r.height};else if(d=='new-line')return{x:s.margin.left+(Math.max(cLine-1,0)*s.rules.size)-rOff+fOff,y:0};else if(d=='prev-line')return{x:s.margin.left+(Math.min(cLine+1,lLine)*s.rules.size)-rOff+fOff,y:r.y};else if(d=='next-line')return{x:s.margin.left+(Math.max(cLine-1,0)*s.rules.size)-rOff+fOff,y:r.y};}},draw:function(r,s,c){if(!r.editing&&s.style[0]=='e')return'';var svg='';var sWidth=Math.max(1,s.width*r.scale);var dash=[(sWidth*3),(sWidth*3)];if(c){if(s.style[0]=='e')c.setLineDash(dash);c.strokeStyle=s.rules.color;c.lineWidth=sWidth;c.lineCap='square';}else{svg+='<g style="stroke-width: '+sWidth+'; stroke-linecap: square;"><g style="stroke: '+s.rules.color+';">';}
if(s.flow=='ltr'||s.flow=='rtl'){var pl=Math.round(r.x*r.scale);var pr=Math.round((r.width+r.x)*r.scale);var xl=Math.round((s.margin.left+r.x)*r.scale);var xr=Math.round((r.x+r.width-s.margin.right)*r.scale);var yt=Math.round(r.y*r.scale);var yb=Math.round((r.height+r.y)*r.scale);var rs=Math.round(s.rules.size*r.scale);var rt=Math.round(yt+rs+(s.margin.top*r.scale));var rb=Math.round((Math.floor((yb-rt-(s.margin.bottom*r.scale))/rs)*rs)+rt);var rl=pl;var rr=pr;if(s.style[0]=='m'){if(c){var rt2=rt;c.setLineDash(dash);while(rt2<rb){if(c){c.beginPath();c.moveTo(pl,rt2);c.lineTo(xl,rt2);c.stroke();c.moveTo(pr,rt2);c.lineTo(xr,rt2);c.stroke();c.closePath();}
rt2+=rs;}
c.setLineDash([]);}
rl=xl;rr=xr;}
while(rt<rb){if(c){c.beginPath();c.moveTo(rl,rt);c.lineTo(rr,rt);c.stroke();c.closePath();}else{svg+='<path d="M '+rl+' '+rt+' L '+rr+' '+rt+'" />';}
rt+=rs;}
if(s.flow=='ltr'){var xp=xl;var xs=xr;}else{var xp=xr;var xs=xl;}
if(c){if(s.style[0]=='m')c.setLineDash(dash);c.strokeStyle=s.margin.color;c.beginPath();c.moveTo(xp,yt);c.lineTo(xp,yb);c.stroke();c.closePath();c.globalAlpha=.4;c.beginPath();c.moveTo(xs,yt);c.lineTo(xs,yb);c.stroke();c.closePath();if(s.style[0]=='m'){c.beginPath();c.moveTo(pl,rb);c.lineTo(xl,rb);c.stroke();c.closePath();c.beginPath();c.moveTo(pr,rb);c.lineTo(xr,rb);c.stroke();c.closePath();c.setLineDash([]);}
c.beginPath();c.moveTo(rl,rb);c.lineTo(rr,rb);c.stroke();c.closePath();c.globalAlpha=1;}else{if(s.style[0]=='m'){svg+='<path d="M '+rl+' '+rb+' L '+rr+' '+rb+'"/>';svg+='</g>';}else{svg+='</g>';svg+='<path d="M '+xs+' '+yt+' L '+xs+' '+yb+'" style="stroke: '+s.margin.color+'; stroke-opacity: .4;" />';if(r.editing)svg+='<path d="M '+pl+' '+rb+' L '+pr+' '+rb+'" style="stroke: '+s.margin.color+'; stroke-opacity: .4;" />';else svg+='<path d="M '+pl+' '+rb+' L '+pr+' '+rb+'" style="stroke: '+s.rules.color+';" />';svg+='<path d="M '+xp+' '+yt+' L '+xp+' '+yb+'" style="stroke: '+s.margin.color+';" />';}}}else if(s.flow=='ttb-ltr'||s.flow=='ttb-rtl'){var pt=Math.round(r.y*r.scale);var pb=Math.round((r.height+r.y)*r.scale);var xl=Math.round(r.x*r.scale);var xr=Math.round((r.width+r.x)*r.scale);var yt=Math.round((s.margin.top+r.y)*r.scale);var yb=Math.round((r.height+r.y-s.margin.bottom)*r.scale);var rs=Math.round(s.rules.size*r.scale);var rl=Math.round(xl+(s.margin.left*r.scale))+rs;var rr=Math.round((Math.floor((xr-rl-(s.margin.right*r.scale))/rs)*rs)+rl)-rs;if(s.flow=='ttb-rtl'){var off=(r.width*r.scale)-(rr-rl)-(rs*2)-((s.margin.right+s.margin.left)*r.scale);rl+=off;rr+=off;}
var rt=pt;var rb=pb;var rc=rl;if(s.style[0]=='m'){if(c){var rc2=rc;c.setLineDash(dash);while(rc2<=rr){if(c){c.beginPath();c.moveTo(rc2,rt);c.lineTo(rc2,yt);c.stroke();c.moveTo(rc2,rb);c.lineTo(rc2,yb);c.stroke();c.closePath();}
rc2+=rs;}
c.setLineDash([]);}
var rt=yt;var rb=yb;}
while(rc<=rr){if(c){c.beginPath();c.moveTo(rc,rt);c.lineTo(rc,rb);c.stroke();c.closePath()}else{svg+='<path d="M '+rc+' '+rt+' L '+rc+' '+rb+'" />';}
rc+=rs;}
rl-=rs;rr+=rs;if(c){if(s.style[0]=='m')c.setLineDash(dash);c.strokeStyle=s.margin.color;c.beginPath();c.moveTo(xl,yt);c.lineTo(xr,yt);c.stroke();c.closePath();c.globalAlpha=.4;c.beginPath();c.moveTo(xl,yb);c.lineTo(xr,yb);c.stroke();c.closePath();if(s.style[0]=='m'){if(s.flow=='ttb-rtl'){c.beginPath();c.moveTo(rr,pt);c.lineTo(rr,pb);c.stroke();c.closePath();c.beginPath();c.moveTo(rl,pt);c.lineTo(rl,rt);c.stroke();c.closePath();c.beginPath();c.moveTo(rl,pb);c.lineTo(rl,rb);c.stroke();c.closePath();c.setLineDash([]);c.beginPath();c.moveTo(rl,rt);c.lineTo(rl,rb);c.stroke();c.closePath();}else{c.beginPath();c.moveTo(rl,pt);c.lineTo(rl,pb);c.stroke();c.closePath();c.beginPath();c.moveTo(rr,pt);c.lineTo(rr,rt);c.stroke();c.closePath();c.beginPath();c.moveTo(rr,pb);c.lineTo(rr,rb);c.stroke();c.closePath();c.setLineDash([]);c.beginPath();c.moveTo(rr,rt);c.lineTo(rr,rb);c.stroke();c.closePath();}}else{c.beginPath();c.moveTo(rr,pt);c.lineTo(rr,pb);c.stroke();c.closePath();c.beginPath();c.moveTo(rl,pt);c.lineTo(rl,pb);c.stroke();c.closePath();}
c.globalAlpha=1;}else{if(s.style[0]=='m'){if(s.flow=='ttb-rtl')svg+='<path d="M '+rl+' '+rt+' L '+rl+' '+rb+'" />';else svg+='<path d="M '+rr+' '+rt+' L '+rr+' '+rb+'" />';svg+='</g>';}else{svg+='</g>';svg+='<path d="M '+xl+' '+yb+' L '+xr+' '+yb+'" style="stroke: '+s.margin.color+'; stroke-opacity: .4;" />';if(s.flow=='ttb-rtl'){svg+='<path d="M '+rr+' '+pt+' L '+rr+' '+pb+'" style="stroke: '+s.margin.color+'; stroke-opacity: .4;" />';if(r.editing)svg+='<path d="M '+rl+' '+pt+' L '+rl+' '+pb+'" style="stroke: '+s.margin.color+'; stroke-opacity: .4;" />';else svg+='<path d="M '+rl+' '+pt+' L '+rl+' '+pb+'" style="stroke: '+s.rules.color+';" />';}else{svg+='<path d="M '+rl+' '+pt+' L '+rl+' '+pb+'" style="stroke: '+s.margin.color+'; stroke-opacity: .4;" />';if(r.editing)svg+='<path d="M '+rr+' '+pt+' L '+rr+' '+pb+'" style="stroke: '+s.margin.color+'; stroke-opacity: .4;" />';else svg+='<path d="M '+rr+' '+pt+' L '+rr+' '+pb+'" style="stroke: '+s.rules.color+';" />';}
svg+='<path d="M '+xl+' '+yt+' L '+xr+' '+yt+'" style="stroke: '+s.margin.color+';" />';}}}
if(c){if(s.style[0]=='e')c.setLineDash([]);}else svg+='</g>';return svg;}}}},shapes:{'line':{draw:function(xy,set,data,ctx){ctx.moveTo(xy.startX,xy.startY);ctx.lineTo(xy.endX,xy.endY);ctx.stroke();},commit:function(xy,set,data){data.drawLine(xy.startX,xy.startY,xy.endX,xy.endY,15);}},'arrow':{draw:function(xy,set,data,ctx){ctx.moveTo(xy.startX,xy.startY);ctx.lineTo(xy.endX,xy.endY);var w=ctx.lineWidth*6;var dx=xy.endX-xy.startX;var dy=xy.endY-xy.startY;var deg=Math.atan2(dy,dx)*180/Math.PI;var a1=(deg-135)%360*Math.PI/180;var a2=(deg+135)%360*Math.PI/180;var tx=xy.endX+(w*Math.cos(a1));var ty=xy.endY+(w*Math.sin(a1));ctx.moveTo(xy.endX,xy.endY);ctx.lineTo(tx,ty);tx=xy.endX+(w*Math.cos(a2));ty=xy.endY+(w*Math.sin(a2));ctx.moveTo(xy.endX,xy.endY);ctx.lineTo(tx,ty);ctx.stroke();},commit:function(xy,set,data){data.drawLine(xy.startX,xy.startY,xy.endX,xy.endY,15);var w=data.state.stroke.activeWidth*6;var dx=xy.endX-xy.startX;var dy=xy.endY-xy.startY;var deg=Math.atan2(dy,dx)*180/Math.PI;var a1=(deg-135)%360*Math.PI/180;var a2=(deg+135)%360*Math.PI/180;var tx=xy.endX+(w*Math.cos(a1));var ty=xy.endY+(w*Math.sin(a1));data.drawLine(xy.endX,xy.endY,tx,ty,5,true);tx=xy.endX+(w*Math.cos(a2));ty=xy.endY+(w*Math.sin(a2));data.drawLine(xy.endX,xy.endY,tx,ty,5,true);}},'rect':{draw:function(xy,set,data,ctx){ctx.rect(Math.min(xy.startX,xy.endX),Math.min(xy.startY,xy.endY),Math.abs(xy.endX-xy.startX),Math.abs(xy.endY-xy.startY));ctx.stroke();},commit:function(xy,set,data){data.drawLine(xy.startX,xy.startY,xy.endX,xy.startY,10);data.drawLine(xy.startX,xy.endY,xy.endX,xy.endY,10,true);data.drawLine(xy.startX,xy.startY,xy.startX,xy.endY,10,true);data.drawLine(xy.endX,xy.startY,xy.endX,xy.endY,10,true);}},},penPreview:function(p,o){$u.o.assign(p,{width:1,color:'#000000',lineCap:'round'},true);$u.o.assign(o,{size:20,width:{show:'auto'},clip:{shape:'circle'}},true);var lc=p.lineCap
if(lc=='butt')lc='square';var r=Math.round(o.size/2);var r2=r-1;var soff=4+Math.round(p.width/2+.499999);var sm=Math.round((o.size-(soff*2))/2);var color='dark';var svg=['<svg width="'+o.size+'" height="'+o.size+'">'];var isTooBig=false;if(p.width>(r-(p.width/1.5))){if(o.clip.shape=='circle'){svg=svg.concat(['<defs>','<clipPath id="A5InkStrokePreviewClip'+o.size+'">','<circle cx="'+r+'" cy="'+r+'" r="'+(r2-2)+'" />','</clipPath>','</defs>']);}else{svg=svg.concat(['<defs>','<clipPath id="A5InkStrokePreviewClip'+o.size+'">','<rect x="0" y="0" width="'+o.size+'" height="'+o.size+'"/>','</clipPath>','</defs>']);}
svg.push('<line x1="'+soff+'" y1="'+r+'" x2="'+(o.size-soff)+'" y2="'+r+'" style="fill: none; stroke: '+p.color+'; stroke-width: '+p.width+'; stroke-linecap: '+lc+';" clip-path="url(#A5InkStrokePreviewClip'+o.size+')" />');isTooBig=true;}else{svg.push('<path d="m '+soff+','+r+' c '+sm+',-'+sm+' '+sm+','+sm+' '+(sm*2)+',0" style="fill: none; stroke: '+p.color+'; stroke-width: '+p.width+'; stroke-linecap: '+lc+';"/>');}
if(o.width.show=='always'||(o.width.show=='auto'&&isTooBig)){svg.push('<g style="opacity: .5;">');svg.push('<text x="'+(o.size-2)+'" y="0" text-anchor="end" font-size="10" dy="10" style="fill: black; stroke: white; stroke-width: 1;">'+p.width+'</text>');svg.push('<text x="'+(o.size-2)+'" y="0" text-anchor="end" font-size="10" dy="10" style="fill: black;">'+p.width+'</text>');svg.push('</g>');}
svg.push('</svg>');return{'svg':svg.join(''),'color':color};},toSVG:function(ink,o){$u.o.assign(o,{size:{width:'auto',height:'auto'},bounds:'page',page:{background:true,lines:true}},true);var data=new A5.ink._.Data();data.fromFormat(ink);var b={x:0,y:0,w:data._maxX,h:data._maxY};if(typeof o.bounds=='object'){if(o.bounds.type=='ink'){var m=typeof o.bounds.margin=='number'?o.bounds.margin:0;b.x=Math.max(data._b.l-m,0);b.y=Math.max(data._b.t-m,0);b.w=Math.min(data._b.r-data._b.l+(m*2),data._maxX-b.x);b.h=Math.min(data._b.b-data._b.t+(m*2),data._maxY-b.y);}else if(o.bounds.type=='explicit'){b.x=o.bounds.x;b.y=o.bounds.y;b.w=o.bounds.width;b.h=o.bounds.height;}}
var scale=1;var w=-1;var h=-1;if(typeof o.size.scale=='number'){scale=o.size.scale;w=b.w*scale;h=b.h*scale;}else if(typeof o.size.zoom=='string'){scale=data.zoomToScale(o.size.zoom);w=b.w*scale;h=b.h*scale;}else{if(o.size.width=='auto'&&o.size.height=='auto'){w=b.w;h=b.h;}else{if(o.size.width!='auto'){if(''+o.size.width==''+Number(o.size.width))w=Number(o.size.width);else w=A5.u.convertUnits(o.size.width,'px');}
if(o.size.height!='auto'){if(''+o.size.height==''+Number(o.size.height))h=Number(o.size.height);else h=A5.u.convertUnits(o.size.height,'px');}
if(w!=-1&&h==-1){scale=w/b.w;h=b.h*scale;}else if(w==-1&&h!=-1){scale=h/b.h;w=b.w*scale;}else{scale=Math.min(w/b.w,h/b.h);}}}
var svg=data.renderRect({x:0,y:0,w:w,h:h},{editing:false,scale:scale,offset:{x:-b.x,y:-b.y},showPageLines:o.page.lines},null);var ps=data.scaleToPageSize(scale);var bg=data.page.background;if(bg.image&&o.page.ackground){var xOff=0-(b.x*scale);var yOff=0-(b.y*scale);if(typeof bg.image.size=='object'){var w=bg.image.size.width*scale;var h=bg.image.size.height*scale;var x=(ps.width-w)/2;var y=(ps.height-h)/2;if(bg.image.position.indexOf('left')!=-1)x=0;else if(bg.image.position.indexOf('right')!=-1)x=ps.width-w;if(bg.image.position.indexOf('top')!=-1)y=0;else if(bg.image.position.indexOf('bottom')!=-1)y=ps.height-h;x=x-xOff;y=y-yOff;svg='<image xlink:href="'+bg.image.data+'" preserveAspectRatio="none" x="'+x+'" y="'+y+'" width="'+w+'px" height="'+h+'px"/>'+svg;}else{var xPos='xMid';var yPos='YMid';if(bg.image.position.indexOf('left')!=-1)xPos='xMin';else if(bg.image.position.indexOf('right')!=-1)xPos='xMax';if(bg.image.position.indexOf('top')!=-1)yPos='YMin';else if(bg.image.position.indexOf('bottom')!=-1)yPos='YMax';if(bg.image.size=='contain'){svg='<image xlink:href="'+bg.image.data+'" preserveAspectRatio="'+xPos+yPos+' meet" x="'+xOff+'" y="'+yOff+'" width="'+ps.width+'px" height="'+ps.height+'px"/>'+svg;}else if(bg.image.size=='cover'){svg='<image xlink:href="'+bg.image.data+'" preserveAspectRatio="'+xPos+yPos+' slice" x="'+xOff+'" y="'+yOff+'" width="'+ps.width+'px" height="'+ps.height+'px"/>'+svg;}}}
svg='<svg viewBox="0 0 '+(b.w*scale)+' '+(b.h*scale)+'" style="width: '+w+'px; height: '+h+'px; background-color: '+bg.color+'">'+svg+'</svg>';return svg;}};A5.ink._.Data=Class.create({initialize:function(s){if(typeof s=='undefined')s={};$u.o.assign(this,{page:{width:300,height:200,unit:'px',dpu:6,lines:false,background:{image:false,color:''}},meta:{bounds:{}},state:{}},true);$u.o.assign(this,s);this.pts=[];this.strokes=[];this.attrs=[];this.state.stroke={maxWidth:1,activeWidth:1};this.state.pen={};this._cStroke=-1;this._cStrokeOff=1;this._cAttr=this.getPenAttr(1,'#000000','r');this._uo=new A5.ink._.Undo();var d=new Date();this.state.created=d.toFormat('yyyy-MM-dd 0h:0m:0s am');this.meta.created=this.state.created;this.meta.modified=this.meta.created;this._initSize();},_initSize:function(){this._maxX=this.page.width*this.page.dpu;this._maxY=this.page.height*this.page.dpu;this._b={l:this._maxX,t:this._maxY,r:0,b:0};$u.o.assign(this.meta.bounds,this._b);if(this.page.lines){if(A5.ink._.pageLines[this.page.lines.type]){var l=A5.ink._.pageLines[this.page.lines.type];if(l.defaults)$u.o.assign(this.page.lines,l.defaults,true);}}},clear:function(){if(arguments[0]==true){this.pts=[];this.strokes=[];this.attrs=[];this.state.stroke={maxWidth:1,activeWidth:1};this._cStroke=-1;this._cStrokeOff=1;this._cAttr=this.getPenAttr(1,'#000000','r');}else{this._uo=null;this.initialize();}},toFormat:function(saveBg){var str='#A5Ink\n';str+='version 1.0\n';var d=new Date();this.meta.created=this.state.created;this.meta.modified=d.toFormat('yyyy-MM-dd 0h:0m:0s am');var md={};$u.o.assign(md,this.meta);md.bounds=this._b;var s={page:this.page,meta:md};s=JSON.stringify(s);str+='settings %json%\n'+s+'\n%json%\n';var attr,penvals;var cattr=-1;var pt,p;var lastx,lasty;var start=true;var saved=0;var saved2=0;var attr=null;for(p=0;p<this.pts.length;p++){pt=this.pts[p];if(pt.x<=0){if(!start){str+='\n';start=true;}
continue;}
if(start){start=false;if(pt.a!=cattr){cattr=pt.a;attr=this.attrs[cattr];penvals=attr.vals;str+='A pen '+penvals.width+' '+penvals.color+$if(penvals.lineCap[0]!='r',' lc:'+penvals.lineCap[0],'')+'\n';}
lastx=pt.x;lasty=pt.y;str+='S '+pt.x+','+pt.y+',';continue;}
dx=Math.floor(pt.x-lastx);dy=Math.floor(pt.y-lasty);lastx=pt.x;lasty=pt.y;if(dx>0){if(dx>=1&&dx<=26)str+=String.fromCharCode(64+dx);else str+='+'+dx;}else if(dx==0){str+='+';}else{if(dx<=-1&&dx>=-26)str+=String.fromCharCode(-dx+96);else str+=dx;}
if(dy>0){if(dy>=1&&dy<=26)str+=String.fromCharCode(64+dy);else str+='+'+dy;}else if(dy==0){str+='+';}else{if(dy<=-1&&dy>=-26)str+=String.fromCharCode(-dy+96);else str+=dy;}}
if(!start)str+='\n';return str;},fromFormat:function(str,onloadfunction){this.clear();if(!str)return;var ch,pos;var classInst=this;function nextChar(){var ch='\n';pos++;if(pos<str.length)ch=str.charAt(pos);return ch;}
function getToken(){var token='';var ch=nextChar();while(ch!=' '&&ch!='\n'&&ch!=','&&ch!='+'&&ch!='-'){token+=ch;ch=nextChar();}
return token;}
function checkForTwo(){return null;if(pos>=str.length)return null;var chnum=str.charCodeAt(pos);if(chnum<33||chnum>41)return null;pos++;var objs=[{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1},{dx:-1,dy:0},{dx:0,dy:0},{dx:1,dy:0},{dx:-1,dy:1},{dx:0,dy:1},{dx:1,dy:1}];return objs[chnum-33];}
function skipToEOL(){if(pos>=str.length)return;var i=str.indexOf('\n',pos);if(i<0)pos=str.length;else pos=i;return;}
function getStrokeDelta(){if(pos>=str.length)return 0;var sign=str.charAt(pos);var code;pos++;if(sign!='+'&&sign!='-'){code=sign.charCodeAt(0);if(code>=65&&code<=90)return code-64;if(code>=97&&code<=122)return-(code-96);return 0;}
var val=0;while(pos<str.length){code=str.charCodeAt(pos);if(code<48||code>57)break;val=10*val+(code-48);pos++;}
return sign=='-'?-val:val;}
function getStroke(){var x=getToken()-0;var y=getToken()-0;var dx,dy,both;var ch;var newpt=classInst.newPointObject(x,y);classInst.pts.push(newpt);nextChar();while(pos<str.length&&str.charAt(pos)!='\n'){both=checkForTwo();if(both){dx=both.dx;dy=both.dy;}else{dx=getStrokeDelta();dy=getStrokeDelta();}
x=x+dx;y=y+dy;newpt=classInst.newPointObject(x,y);classInst.pts.push(newpt);}
classInst.pts.push(classInst.newZeroPointObject());}
var cmd,cmd2,a,b,c,d,e,f,marker;pos=-1;while(pos<str.length){cmd=getToken()||'#';cmd2=cmd.substring(0,2);if(cmd=='')skipToEOL();else if(cmd.charAt(0)=='#')skipToEOL();else if(cmd.charAt(0)=='v')skipToEOL();else if(cmd2=='se'){marker=getToken();skipToEOL();a=str.indexOf('\n'+marker+'\n',pos+1);if(a<0)a=str.length;b=str.substring(pos+1,a);pos=a+marker.length;skipToEOL();c=JSON.parse(b);$u.o.assign(this.page,c.page);$u.o.assign(this.meta,c.meta);if(c.meta.created)this.state.created=c.meta.created;if(c.meta.bounds)$u.o.assign(this._b,c.meta.bounds);this._initSize();}else if(cmd.charAt(0)=='S'){getStroke();skipToEOL();}else if(cmd.charAt(0)=='A'){a=getToken();if(a=='pen'){a=str.indexOf('\n',pos+1);if(a<0)a=str.length;b=str.substring(pos+1,a);pos=a;b=b.split(' ');c='r';if(b[2])c=b[2].split(':').pop();if(c=='s')c='square';else if(c=='b')c='butt';else c='round'
this._cAttr=this.getPenAttr(b[0]-0,b[1],c);}
skipToEOL();}else{skipToEOL();}}
this.rebuildStrokes();},newPointObject:function(x,y){x=Math.round(x);y=Math.round(y);var x1=x>0?(x<this._maxX?x:this._maxX):1;var y1=y>0?(y<this._maxY?y:this._maxY):1;var npo={x:x1,y:y1,a:this._cAttr};return npo;},newZeroPointObject:function(){var nzpo={x:0,y:0,a:-1};return nzpo;},newStrokeObject:function(){var nso={start:-1,bounds:{l:this._maxX,t:this._maxY,r:0,b:0}};return nso;},newAttrObject:function(){var nao={type:0,vals:null};return nao;},attrMap:{pen:1},newAttrPenObject:function(){var napo={color:'#000000',width:1,lineCap:'r'};return napo;},getPenAttr:function(w,c,lc){var num,attr;for(num=0;num<this.attrs.length;num++){attr=this.attrs[num];if(attr.type==this.attrMap.pen&&attr.vals.color==c&&attr.vals.width==w&&attr.vals.lineCap==lc){$u.o.assign(this.state.pen,attr.vals);this.state.stroke.activeWidth=w;return num;}}
var ao=this.newAttrObject();ao.type=this.attrMap.pen;var pa=this.newAttrPenObject();pa.color=c;pa.width=w;pa.lineCap=lc;ao.vals=pa;this.attrs.push(ao);$u.o.assign(this.state.pen,pa);this.state.stroke.maxWidth=Math.max(w,this.state.stroke.maxWidth);this.state.stroke.activeWidth=w;this._cStrokeOff=Math.round(Math.sqrt(((w/2)*(w/2))*2)+.4999);return this.attrs.length-1;},startStroke:function(x,y){var addTo=typeof arguments[2]!='undefined'?arguments[2]:false;var newpt=this.newPointObject(x,y);this.pts.push(newpt);if(addTo)this._uo.addToUndo(this._uo.newUndo(this.pts.length-1,0,0,-1,newpt.x,newpt.y,this._cAttr));else this._uo.addUndo(this._uo.newUndo(this.pts.length-1,0,0,-1,newpt.x,newpt.y,this._cAttr));var newstroke=this.newStrokeObject();newstroke.start=this.pts.length-1;this.strokes.push(newstroke);this._cStroke=this.strokes.length-1;this.adjustCurrentStrokeBounds(newpt.x,newpt.y);this.inStroke=true;},addToStroke:function(x,y){var newpt=this.newPointObject(x,y);this.pts.push(newpt);this._uo.addToUndo(this._uo.newUndo(this.pts.length-1,0,0,-1,newpt.x,newpt.y,this._cAttr));this.adjustCurrentStrokeBounds(newpt.x,newpt.y);},endStroke:function(x,y){var len=this.pts.length;var newpt=this.newPointObject(x,y);if(len==0||this.pts[len-1].x!=newpt.x||this.pts[len-1].y!=newpt.y){this.pts.push(newpt);this._uo.addToUndo(this._uo.newUndo(this.pts.length-1,0,0,-1,newpt.x,newpt.y,-1));this.adjustCurrentStrokeBounds(newpt.x,newpt.y);}
this.adjustBoundsWithCurrentStroke();this.pts.push(this.newZeroPointObject());},adjustCurrentStrokeBounds:function(x,y){x=Math.round(x);y=Math.round(y);if(x-this._cStrokeOff<this.strokes[this._cStroke].bounds.l)this.strokes[this._cStroke].bounds.l=x-this._cStrokeOff;if(x+this._cStrokeOff>this.strokes[this._cStroke].bounds.r)this.strokes[this._cStroke].bounds.r=x+this._cStrokeOff;if(y-this._cStrokeOff<this.strokes[this._cStroke].bounds.t)this.strokes[this._cStroke].bounds.t=y-this._cStrokeOff;if(y+this._cStrokeOff>this.strokes[this._cStroke].bounds.b)this.strokes[this._cStroke].bounds.b=y+this._cStrokeOff;},adjustBoundsWithCurrentStroke:function(){if(this.strokes[this._cStroke].bounds.l<this._b.l)this._b.l=this.strokes[this._cStroke].bounds.l;if(this.strokes[this._cStroke].bounds.r>this._b.r)this._b.r=this.strokes[this._cStroke].bounds.r;if(this.strokes[this._cStroke].bounds.t<this._b.t)this._b.t=this.strokes[this._cStroke].bounds.t;if(this.strokes[this._cStroke].bounds.b>this._b.b)this._b.b=this.strokes[this._cStroke].bounds.b;},rebuildStrokes:function(){var p,pt,stroke;this.strokes=[];this._b={l:this._maxX,t:this._maxY,r:0,b:0};stroke=this.newStrokeObject();this.strokes.push(stroke);this._cStroke=0;for(p=0;p<this.pts.length;p++){pt=this.pts[p];if(pt.x!=0){if(stroke.start==-1)stroke.start=p;this.adjustCurrentStrokeBounds(pt.x,pt.y);}else{if(stroke.start!=-1){this.adjustBoundsWithCurrentStroke();stroke=this.newStrokeObject();this.strokes.push(stroke);this._cStroke=this.strokes.length-1;}}}
if(stroke.start==-1){this.strokes.pop();this._cStroke=this.strokes.length-1;}},erasePoints:function(x,y,size,numSoFar){var left=x-size/2;var top=y-size/2;var right=left+size;var bottom=top+size;var p,pt;var n=numSoFar;for(p=0;p<this.pts.length;p++){pt=this.pts[p];if(pt.x>=left&&pt.x<=right&&pt.y>=top&&pt.y<=bottom){if(n==0)this._uo.addUndo(this._uo.newUndo(p,pt.x,pt.y,pt.a,0,0,-1));else this._uo.addToUndo(this._uo.newUndo(p,pt.x,pt.y,pt.a,0,0,-1));n++;pt.x=0;pt.y=0;pt.a=-1;}}
this.rebuildStrokes();return n;},undo:function(){var undoredos=this._uo.nextUndo();if(!undoredos)return;var i,undoredo,pt;for(i=undoredos.length-1;i>=0;i--){undoredo=undoredos[i];pt=this.pts[undoredo.p];pt.x=undoredo.ox;pt.y=undoredo.oy;pt.a=undoredo.oa;}
this.rebuildStrokes();},redo:function(){var undoredos=this._uo.nextRedo();if(!undoredos)return;var i,undoredo,pt;for(i=0;i<=undoredos.length-1;i++){undoredo=undoredos[i];pt=this.pts[undoredo.p];pt.x=undoredo.nx;pt.y=undoredo.ny;pt.a=undoredo.na;}
this.rebuildStrokes();},zoomToScale:function(z){if(typeof z=='object'){var margin=typeof z.margin!='undefined'?z.margin:0;if(z.fit=='both'){var w=z.width-(margin*2);var h=z.height-(margin*2);return Math.min(w/this._maxX,h/this._maxY);}else if(z.fit=='width'){var w=z.width-(margin*2);return w/this._maxX;}else if(z.fit=='height'){var h=z.height-(margin*2);return h/this._maxY;}}else{if(typeof z=='string')z=$u.s.toNum(z);var w=A5.u.convertUnits(this.page.width,this.page.unit,'px');return(w/this._maxX)*(z/100);}},scaleToPageSize:function(s){return{width:this._maxX*s,height:this._maxY*s,dpp:1/s};},drawLine:function(x1,y1,x2,y2,step){dx=x2-x1;dy=y2-y1;m=Math.floor(Math.sqrt((dx*dx)+(dy*dy))/step);this.startStroke(x1,y1,arguments[5]);if(m>0){for(var i=0;i<=m;i++){this.addToStroke(x1+(dx/m*i),y1+(dy/m*i));}}
this.endStroke(x2,y2);},renderRect:function(r,o,c){if(typeof c=='undefined'||c==null)c=false;if(r==null)r=false;if(!c)var sgv='';$u.o.assign(o,{editing:false,clear:true,showPageLines:true,scale:1,offset:{x:0,y:0},line:{defaultWidth:3,maxWidth:500,minWidth:1},stroke:{first:0,last:-1}},true);var cr=false;if(r)cr={l:(r.x/o.scale)-o.offset.x,t:(r.y/o.scale)-o.offset.y,r:((r.x+r.w)/o.scale)-o.offset.x,b:((r.y+r.h)/o.scale)-o.offset.y};if(o.line.defaultWidth<o.line.minWidth)o.line.defaultWidth=o.line.minWidth;if(o.line.defaultWidth>o.line.maxWidth)o.line.defaultWidth=o.line.maxWidth;if(o.stroke.last==-1||o.stroke.last>this.strokes.length-1)o.stroke.last=this.strokes.length-1;if(c&&r){r.x=Math.round(r.x);r.y=Math.round(r.y);r.w=Math.round(r.w);r.h=Math.round(r.h);if(o.clear){c.beginPath();c.clearRect(r.x,r.y,r.w,r.h);c.stroke();}
c.save();c.rect(r.x,r.y,r.w,r.h);c.clip();}
var svg='';if(o.showPageLines&&this.page.lines){if(A5.ink._.pageLines[this.page.lines.type]){svg+=A5.ink._.pageLines[this.page.lines.type].draw.call(this,{editing:o.editing,x:o.offset.x,y:o.offset.y,width:this._maxX,height:this._maxY,scale:o.scale,clip:r},this.page.lines,c);}}
if(o.stroke.first>o.stroke.last){if(c&&r)c.restore();return svg;}
var b,s,p,pt,pattr,sColor,sWidth,sLineCap;var lastx;var lasty;var x,y;var midx,midy,lastmidx,lastmidy;var dx,dy,dx1,dx2,dy1,dy2,mindelta;var ln;var lastattr=-1;var wrote=false;sWidth=o.line.defaultWidth*o.scale;if(sWidth<o.line.minWidth)sWidth=o.line.minWidth;if(sWidth>o.line.maxWidth)sWidth=o.line.maxWidth;if(c){c.lineWidth=sWidth;c.lineCap='round';c.lineJoin='round';}else{svg+='<g style="fill:none; stroke-linejoin: round; stroke-linecap: round;">';svg+='<g style="stroke:#000000; stroke-width:'+sWidth+';">';}
for(s=o.stroke.first;s<=o.stroke.last;s++){if(cr){b=this.strokes[s].bounds;if(cr.l>b.r||cr.r<b.l||cr.t>b.b||cr.b<b.t)continue;}
p=this.strokes[s].start;pt=this.pts[p];if(pt.a!=lastattr){if(pt.a<0||pt.a>=this.attrs.length)alert('Bad last attrib: '+pt.a);pattr=this.attrs[pt.a].vals;sWidth=pattr.width*o.scale;if(sWidth<o.line.minWidth)sWidth=o.line.minWidth;if(sWidth>o.line.maxWidth)sWidth=o.line.maxWidth;sColor=pattr.color;sLineCap=pattr.lineCap;if(c){c.lineWidth=sWidth;c.strokeStyle=sColor;c.lineCap=sLineCap;}else{svg+='</g><g style="stroke:'+sColor+'; stroke-width:'+sWidth+'; stroke-linecap: '+sLineCap+'">';}
lastattr=pt.a;}
lastx=(pt.x+o.offset.x)*o.scale;lasty=(pt.y+o.offset.y)*o.scale;lastmidx=lastx;lastmidy=lasty;if(c)c.beginPath();else svg+='<path d="';if(c)c.moveTo(lastx,lasty);else svg+='M '+lastx+' '+lasty+' ';wrote=false;for(p+=1;p<this.pts.length;p++){pt=this.pts[p];if(pt.x==0)break;x=(pt.x+o.offset.x)*o.scale;y=(pt.y+o.offset.y)*o.scale;dx=Math.abs(x-lastx);dy=Math.abs(y-lasty);if(dx<1.0&&dy<1.0)continue;midx=(x+lastx)/2.0;midy=(y+lasty)/2.0;ln=false;if(lastmidx>0&&sWidth>1.0){dx1=lastx-lastmidx;dy1=lasty-lastmidy;dx2=lastx-midx;dy2=lasty-midy;mindelta=0.5*sWidth;if(Math.abs(dx1)<mindelta){if(Math.abs(dx2)<mindelta&&((dy1<0&&dy2<0)||(dy1>0&&dy2>0))){if(4*Math.abs(dx1)<=Math.abs(dy1)&&4*Math.abs(dx2)<=Math.abs(dy2))ln=true;}}
if(Math.abs(dy2)<mindelta){if(Math.abs(dy2)<mindelta&&((dx1<0&&dx2<0)||(dx1>0&&dx2>0))){if(4*Math.abs(dy1)<=Math.abs(dx1)&&4*Math.abs(dy2)<=Math.abs(dx2))ln=true;}}}
if(dx<3.0&&dy<3.0){ln=true;}
if(ln&&sWidth>1.0&&lastmidx>0){dx1=lastx-lastmidx;dy1=lasty-lastmidy;dx2=lastx-midx;dy2=lasty-midy;if(dx1==0){if(dx2==0&&((dx1<0&&dx2<0)||(dx1>0&&dx2>0)))x=x+1;}else if(dy1==0){if(dy2==0&&((dx1<0&&dx2<0)||(dx1>0&&dx2>0)))y=y+1;}else if(dx2/dx1==dy2/dy1&&((dx1<0&&dx2<0)||(dx1>0&&dx2>0))){x=x+1;}
midx=x;midy=y;}
lastmidx=midx;lastmidy=midy;if(c){if(ln)c.lineTo(midx,midy);else c.quadraticCurveTo(lastx,lasty,midx,midy);}else{if(ln)svg+='L '+midx+' '+midy+' ';else svg+='Q '+lastx+' '+lasty+' '+midx+' '+midy+' ';}
if(!wrote&&(lastx!=x||lasty!=y))wrote=true;lastx=x;lasty=y;}
if(!wrote)lastx+=1;if(c){c.lineTo(lastx,lasty);c.stroke();}else{svg+='L '+lastx+' '+lasty+'" />';}}
if(c){if(r)c.restore();return true;}else{svg+='</g></g>';return svg;}},renderImage:function(imageType,width,height,back,quality){var canvas=document.createElement('canvas');canvas.width=width;var ourheight=height>0?height:width*(this._maxY/this._maxX);canvas.height=ourheight;if(back)canvas.style.backgroundColor=back;var ctx=canvas.getContext("2d");if(back){ctx.beginPath();ctx.fillStyle=back;ctx.fillRect(0,0,width,ourheight);ctx.stroke();}
var options={editing:true,scale:width/this._maxX,linewidth:1.0,showBackground:true};this.renderRect(null,options,ctx);var str;if(quality)str=canvas.toDataURL(imageType=="jpeg"?"image/jpeg":"image/png",quality);else str=canvas.toDataURL(imageType=="jpeg"?"image/jpeg":"image/png");delete canvas;return str;}});A5.ink._.Undo=Class.create({initialize:function(){$u.o.assign(this,{undoStack:[],undoTOS:-1,maxUndoSteps:100});},newUndo:function(p,ox,oy,oa,nx,ny,na){var ud={p:(p),ox:(ox),oy:(oy),oa:(oa),nx:(nx),ny:(ny),na:(na)};return ud;},addUndo:function(undoRedo){this.undoStack.length=this.undoTOS+1;var undoredos=[];undoredos.push(undoRedo);this.undoStack.push(undoredos);if(this.undoStack.length>this.maxUndoSteps){this.undoStack.splice(0,this.undoStack.length-this.maxUndoSteps);}
this.undoTOS=this.undoStack.length-1;},addToUndo:function(undoRedo){this.undoStack[this.undoTOS].push(undoRedo);},nextUndo:function(){var undoredos=null;if(this.undoTOS>=0){undoredos=this.undoStack[this.undoTOS];this.undoTOS--;}
return undoredos;},nextRedo:function(){var undoredos=null;if(this.undoTOS<this.undoStack.length-1){this.undoTOS++;undoredos=this.undoStack[this.undoTOS];}
return undoredos;},canUndo:function(){return this.undoTOS>=0;},canRedo:function(){return this.undoTOS<this.undoStack.length-1;},saveUndoState:function(){return{undoStack:this.undoStack,undoTOS:this.undoTOS,maxUndoSteps:this.maxUndoSteps};},loadUndoState:function(savedState){if(!savedState||!savedState.undoStack)return;this.undoStack=savedState.undoStack;this.undoTOS=savedState.undoTOS;this.maxUndoSteps=savedState.maxUndoSteps;},resetUndoState:function(){this.undoStack=[];this.undoTOS=-1;}});A5.Ink=Class.create({initialize:function(contId,settings){this.contId=contId;$u.o.assign(this,{theme:'',override:'base',inputId:'',autoCommit:false,layout:'split',previewSize:512,page:{},view:{detached:{id:''},scale:{fit:'both',margin:10,lock:true},className:'',zoomBox:{className:'',navigateClassName:'',scale:{allow:true,className:'',from:'bottom-right'}},page:{className:'',offset:0},overlay:{show:false,html:''}},editor:{scale:false,className:'',page:{className:'',offset:0},overlay:{show:false,html:''}},split:{layout:'v-view-editor',size:'300px'},items:{},tools:{pen:{activeClassName:'',smooth:2,base:{color:'#000',width:3,lineCap:'round'},preview:{size:38,width:{show:'never'},clip:{shape:'circle'}}},eraser:{activeClassName:'',areaClassName:'',size:50,max:400,min:20},pan:{activeClassName:''}},status:{messages:{'tool:pen':'','tool:eraser':'Eraser','tool:pan':'Drag to pan','item:eraser':'Drag to size eraser','item:undo':'Drag to navigate undo stack','item:redo':'Drag to navigate undo stack','item:navigate':'Drag to pan','item:navigate:new-line':'Drag to move between lines'}},state:{active:'editor',undo:false,redo:false,tool:{type:'pen',sticky:false,settings:false},pen:{},view:{autoScale:false,detached:false,width:0,height:0,offset:{x:0,y:0},scale:.15},editor:{autoScale:false,width:0,height:0,offset:{x:0,y:0},scale:1}},onChange:false,onBeforeCommit:false,onCommit:false,onToolChange:false,onPenChange:false,onBackgroundChange:false});if(typeof settings.theme!='undefined')A5.themes.assign(this,settings.theme,'ink');$u.o.assign(this,settings);A5.overrides.assign(this,'ink',this.override);var dSet={page:{}};$u.o.assign(dSet.page,this.page);this.data=new A5.ink._.Data(dSet);this.value=this.data.toFormat();this._vNav=false;this._eNav=false;this._render();},setValue:function(v){this.data.fromFormat(v);this.navigate('view','start');this.navigate('editor','start');this._resize();this._change();this.setPen(this.tools.pen.base);if(this.autoCommit)this.commit();},commit:function(){if(typeof this.onBeforeCommit=='function')this.onBeforeCommit.call(this);this.value=this.data.toFormat();if(this.inputId!=''){$svs(this.inputId,this.value);$e.execute(this.inputId,'change');}
if(typeof this.onCommit=='function')this.onCommit.call(this,this.value);},clear:function(){this.data.clear();this.navigate('view','start');this.navigate('editor','start');this._repaint();this._change();this.setStatus();this.setPen(this.tools.pen.base);if(this.autoCommit)this.commit();},undo:function(){this.data.undo();this._repaint();this._change();if(this.autoCommit)this.commit();},redo:function(){this.data.redo();this._repaint();this._change();if(this.autoCommit)this.commit();},refresh:function(){this._resize();},setTool:function(tool){tool=tool.toLowerCase();var tList=['pen','eraser','pan','draw-shape'];if(tList.indexOf(tool)==-1)tool='pen';var s=typeof arguments[2]!='undefined'?arguments[2]:false;var oldTool=this.state.tool.type;this.state.tool.sticky=typeof arguments[1]=='boolean'?arguments[1]:false;this.state.tool.type=tool;this.state.tool.settings=s;if(this.tools[oldTool]){if(this.tools[oldTool].activeClassName!='')$rcn(this.contId,this.tools[oldTool].activeClassName);}
if(this.tools[tool]){if(this.tools[tool].activeClassName!='')$acn(this.contId,this.tools[tool].activeClassName);}
if(typeof this.onToolChange=='function')this.onToolChange.call(this,tool,oldTool);this.setStatus();},setPen:function(o){$u.o.assign(o,{color:'#000000',width:1,lineCap:'round'},true);if(o.color.constructor==Array){if(o.color.length==4){o.color='rgba('+$u.s.toNum(o.color[0])+','+$u.s.toNum(o.color[1])+','+$u.s.toNum(o.color[2])+','+$u.s.toNum(o.color[3])+')';}else if(o.color.length==3){o.color='rgb('+$u.s.toNum(o.color[0])+','+$u.s.toNum(o.color[1])+','+$u.s.toNum(o.color[2])+')';}else o.color='#000000';}else{o.color=o.color.toLowerCase();var f4=o.color.substr(0,4);var f5=o.color.substr(0,5);if(o.color[0]=='#'){o.color='#'+o.color.replace(/[^0-9a-f]/gi,'');}else if(f4=='rgb('||f4=='hls('){o.color=o.color.replace(/[^0-9,\.%]/gi,'');var c=o.color.split(',');if(c.length>2)o.color=f4+c[0]+','+c[1]+','+c[2]+')';else o.color='#000000';}else if(f5=='rgba('||f5=='hlsa('){o.color=o.color.replace(/[^0-9,\.%]/gi,'');var c=o.color.split(',');if(c.length>3)o.color=f5+c[0]+','+c[1]+','+c[2]+','+c[3]+')';else o.color='#000000';}else o.color='#000000';}
this.data._cAttr=this.data.getPenAttr(o.width,o.color,o.lineCap);if(this._ppEle){var spObj=A5.ink.penPreview(this.data.state.pen,this.tools.pen.preview);this._ppEle.innerHTML=spObj.svg;}
$u.o.assign(this.state.pen,this.data.state.pen);if(typeof this.onPenChange=='function')this.onPenChange.call(this,o);},setPage:function(p){$u.o.assign(this.data.page,p);this.data._initSize();this._resize();if(this.autoCommit)this.commit();},setBackground:function(bs){if(bs==false||bs==null||typeof bs=='undefined'){this.data.page.background.image=false;this.data.page.background.color='';this._epbEle.style.backgroundImage='';this._vpbEle.style.backgroundImage='';this._epbEle.style.backgroundColor='';this._vpbEle.style.backgroundColor='';}else{$u.o.assign(this.data.page.background,bs);this._epbEle.style.backgroundColor=this.data.page.background.color;this._vpbEle.style.backgroundColor=this.data.page.background.color;if(this.data.page.background.image){$u.o.assign(this.data.page.background.image,{type:'image',data:'',position:'center',size:'contain'},true);this._epbEle.style.backgroundImage='url('+this.data.page.background.image.data+')';this._epbEle.style.backgroundSize=this.data.page.background.image.size;this._epbEle.style.backgroundPosition=this.data.page.background.image.position;this._vpbEle.style.backgroundImage='url('+this.data.page.background.image.data+')';this._vpbEle.style.backgroundSize=this.data.page.background.image.size;this._vpbEle.style.backgroundPosition=this.data.page.background.image.position;}else{this._epbEle.style.backgroundImage='';this._vpbEle.style.backgroundImage='';}
this._epbEle.style.display='block';this._vpbEle.style.display='block';this._repaint();}
if(typeof this.onBackgroundChange=='function')this.onBackgroundChange.call(this,this.data.page.background);if(this.autoCommit)this.commit();},metaData:function(){var md=typeof arguments[0]=='object'?arguments[0]:false;if(md)$u.o.assign(this.data.meta,md);$u.o.assign(this.data.meta.bounds,this.data._b);if(this.autoCommit)this.commit();return this.data.meta;},setOverlay:function(p,o){if(p=='editor'){var ele=$(this.contId+'.EDITOR.OVERLAY')
if(o){if(typeof o=='string'){o=o.replace(/\{id\}/gi,this.contId);ele.innerHTML=o;this.editor.overlay.html=o;}
ele.style.display='';this.editor.overlay.show=true;}else{ele.style.display='none';this.editor.overlay.show=false;}}else if(p=='view'){var ele=$(this.contId+'.VIEW.OVERLAY')
if(o){if(typeof o=='string'){o=o.replace(/\{id\}/gi,this.contId);ele.innerHTML=o;this.view.overlay.html=o;}
ele.style.display='';this.view.overlay.show=true;}else{ele.style.display='none';this.view.overlay.show=false;}}
this._sEle=$(this.contId+'.STATUS');},setStatus:function(){if(this._sEle){var msg=typeof arguments[0]!='undefined'?arguments[0]:false;var html='';if(typeof msg=='object'){html=msg.html;}else if(this.status.messages){if(typeof msg=='string'){if(this.status.messages[msg])html=this.status.messages[msg];}else{if(this.status.messages['tool:'+this.state.tool.type])html=this.status.messages['tool:'+this.state.tool.type];}}
this._sEle.innerHTML=html;if(html=='')this._sEle.style.display='none';else this._sEle.style.display='';}},navigate:function(p,d){var wCmd=['forward','back','new-line','prev-line','next-line','line-start','line-end','start','end'];if(p=='editor'){if(wCmd.indexOf(d)!=-1){if(this.data.page.lines){var pl=A5.ink._.pageLines[this.data.page.lines.type];if(pl){if(pl.navigate){var res=pl.navigate(d,{x:this.state.editor.offset.x,y:this.state.editor.offset.y,width:this.data._maxX,height:this.data._maxY,clip:{width:this.state.editor.width/this.state.editor.scale,height:this.state.editor.height/this.state.editor.scale}},this.data.page.lines);if(typeof res=='object'){this._offset('editor',res.x,res.y);this._repaint();return true;}else if(typeof res=='string')d=res;}}}}
var eEle=$(this.contId+'.EDITOR');var ps=this.data.scaleToPageSize(this.state.editor.scale);var w=eEle.offsetWidth;var h=eEle.offsetHeight;var pw=Math.min(ps.width,w);var ph=Math.min(ps.height,h);var maxOffX=0;var maxOffY=0;if(ps.width>w)maxOffX=(ps.width-w)*ps.dpp;if(ps.height>h)maxOffY=(ps.height-h)*ps.dpp;var move=.5;if(d.substr(0,6)=='nudge-'){move=.1;d=d.substr(6);}
var wIndx=wCmd.indexOf(d);if(wIndx!=-1){var wrCmd=['right','left',{x:0,y:false,m:'down'},'up','down',{x:0,y:false,m:false},{x:maxOffX,y:false,m:false},{x:0,y:0,m:false},{x:maxOffX,y:maxOffY,m:false}];d=wrCmd[wIndx];if(typeof d=='object'){if(typeof d.x=='number')this.state.editor.offset.x=d.x;if(typeof d.y=='number')this.state.editor.offset.y=d.y;if(typeof d.m=='string')d=d.m;else{this._repaint();return true;}}}
if(d[0]=='l'||d[0]=='r'){var a=(eEle.offsetWidth*move)/this.state.editor.scale;if(d[0]=='l')this.state.editor.offset.x-=a;else this.state.editor.offset.x+=a;this.state.editor.offset.x=Math.min(Math.max(0,this.state.editor.offset.x),maxOffX);}else if(d[0]=='u'||d[0]=='d'){var a=(eEle.offsetHeight*move)/this.state.editor.scale;if(d[0]=='u')this.state.editor.offset.y-=a;else this.state.editor.offset.y+=a;this.state.editor.offset.y=Math.min(Math.max(0,this.state.editor.offset.y),maxOffY);}
this._repaint();}else if(p=='view'){if(wCmd.indexOf(d)!=-1){if(this.data.page.lines){var pl=A5.ink._.pageLines[this.data.page.lines.type];if(pl){if(pl.navigate){var res=pl.navigate(d,{x:this.state.view.offset.x,y:this.state.view.offset.y,width:this.data._maxX,height:this.data._maxY,clip:{width:this.state.view.width/this.state.view.scale,height:this.state.view.height/this.state.view.scale}},this.data.page.lines);if(typeof res=='object'){this._offset('view',res.x,res.y);this._repaint();return true;}else if(typeof res=='string')d=res;}}}}
var vEle=$(this.contId+'.VIEW');var ps=this.data.scaleToPageSize(this.state.view.scale);var w=vEle.offsetWidth;var h=vEle.offsetHeight;var pw=Math.min(ps.width,w);var ph=Math.min(ps.height,h);var maxOffX=0;var maxOffY=0;if(ps.width>w)maxOffX=(ps.width-w)*ps.dpp;if(ps.height>h)maxOffY=(ps.height-h)*ps.dpp;var move=.5;if(d.substr(0,6)=='nudge-'){move=.1;d=d.substr(6);}
var wIndx=wCmd.indexOf(d);if(wIndx!=-1){var wrCmd=['right','left',{x:0,y:false,m:'down'},'up','down',{x:0,y:false,m:false},{x:maxOffX,y:false,m:false},{x:0,y:0,m:false},{x:maxOffX,y:maxOffY,m:false}];d=wrCmd[wIndx];if(typeof d=='object'){if(typeof d.x=='number')this.state.view.offset.x=d.x;if(typeof d.y=='number')this.state.view.offset.y=d.y;if(typeof d.m=='string')d=d.m;else{this._repaint();return true;}}}
if(d[0]=='l'||d[0]=='r'){var a=(vEle.offsetWidth*move)/this.state.view.scale;if(d[0]=='l')this.state.view.offset.x-=a;else this.state.view.offset.x+=a;this.state.view.offset.x=Math.min(Math.max(0,this.state.view.offset.x),maxOffX);}else if(d[0]=='u'||d[0]=='d'||d[0]=='n'){var a=(vEle.offsetHeight*move)/this.state.view.scale;if(d[0]=='u')this.state.view.offset.y-=a;else this.state.view.offset.y+=a;if(d[0]=='n')this.state.view.offset.x=0;this.state.view.offset.y=Math.min(Math.max(0,this.state.view.offset.y),maxOffY);}
this._repaint();}},_change:function(){this.state.undo=this.data._uo.canUndo();this.state.redo=this.data._uo.canRedo();if(typeof this.onChange=='function')this.onChange.call(this);},_resize:function(){if(this.state.view.detached)this.layout='detached-view';var cEle=$(this.contId);var vEle=$(this.contId+'.VIEW');var eEle=$(this.contId+'.EDITOR');var eRefresh=true;var vRefresh=true;if(this.layout=='view'||(this.layout=='split'&&this.split.layout=='view')){vEle.style.display='';vEle.style.top='0px';vEle.style.left='0px';vEle.style.right='0px';vEle.style.bottom='0px';eEle.style.display='none';eRefresh=false;}else if(this.layout=='editor'||this.layout=='detached-view'||(this.layout=='split'&&this.split.layout=='editor')){if(this.layout=='detached-view')vEle.style.display='';else{vEle.style.display='none';vRefresh=false;}
eEle.style.top='0px';eEle.style.left='0px';eEle.style.right='0px';eEle.style.bottom='0px';eEle.style.display='';}else if(this.layout=='split'){if(this.split.layout=='v-view-editor'){var eSize=A5.u.convertUnits(this.split.size,'px');var vh=(cEle.offsetHeight-eSize)+'px';vEle.style.top='0px';vEle.style.left='0px';vEle.style.right='0px';vEle.style.bottom=this.split.size;vEle.style.display='';eEle.style.top=vh;eEle.style.left='0px';eEle.style.right='0px';eEle.style.bottom='0px';eEle.style.display='';}else if(this.split.layout=='v-editor-view'){var eSize=A5.u.convertUnits(this.split.size,'px');vEle.style.top=this.split.size;vEle.style.left='0px';vEle.style.right='0px';vEle.style.bottom='0px';vEle.style.display='';eEle.style.top='0px';eEle.style.left='0px';eEle.style.right='0px';eEle.style.bottom=(cEle.offsetHeight-eSize)+'px';eEle.style.display='';}else if(this.split.layout=='h-editor-view'){var eSize=A5.u.convertUnits(this.split.size,'px');vEle.style.top='0px';vEle.style.left=this.split.size;vEle.style.right='0px';vEle.style.bottom='0px';vEle.style.display='';eEle.style.top='0px';eEle.style.left='0px';eEle.style.right=(cEle.offsetWidth-eSize)+'px';eEle.style.bottom='0px';eEle.style.display='';}else if(this.split.layout=='h-view-editor'){var eSize=A5.u.convertUnits(this.split.size,'px');vEle.style.top='0px';vEle.style.left='0px';vEle.style.right=this.split.size;vEle.style.bottom='0px';vEle.style.display='';eEle.style.top='0px';eEle.style.left=(cEle.offsetWidth-eSize)+'px';eEle.style.right='0px';eEle.style.bottom='0px';eEle.style.display='';}}
if(eRefresh){this.state.editor.autoScale=false;if(this.editor.scale){$u.o.assign(this.editor.scale,{fit:'both',margin:10,lock:false},true);this.state.editor.scale=this.data.zoomToScale({fit:this.editor.scale.fit,width:eEle.offsetWidth,height:eEle.offsetHeight,margin:this.editor.scale.margin});if(this.state.editor.scale==0)this.state.editor.scale=1;if(this.editor.scale.lock)this.state.editor.autoScale=true;}
var ps=this.data.scaleToPageSize(this.state.editor.scale);var w=eEle.offsetWidth;var h=eEle.offsetHeight;var pw=Math.min(ps.width,w);var ph=Math.min(ps.height,h);var maxOffX=0;var maxOffY=0;if(ps.width>w)maxOffX=Math.max((ps.width-w)*ps.dpp,0);if(ps.height>h)maxOffY=Math.max((ps.height-h)*ps.dpp,0);this.state.editor.offset.x=Math.min(this.state.editor.offset.x,maxOffX);this.state.editor.offset.y=Math.min(this.state.editor.offset.y,maxOffY);var epOff=this.editor.page.offset;this._epEle.style.width=(pw)+'px';this._epEle.style.height=(ph)+'px';this._epEle.style.left=(((w-pw)/2)-epOff)+'px';this._epEle.style.top=(((h-ph)/2)-epOff)+'px';this._enpEle.style.left=(0-epOff)+'px';this._enpEle.style.top=(0-epOff)+'px';this._bcEle.width=pw;this._bcEle.height=ph;this._fcEle.width=pw;this._fcEle.height=ph;this.state.editor.width=w;this.state.editor.height=h;this._repaintEditor();}
if(vRefresh){this.state.view.autoScale=false;if(this.view.scale){$u.o.assign(this.view.scale,{fit:'both',margin:10,lock:false},true);this.state.view.scale=this.data.zoomToScale({fit:this.view.scale.fit,width:vEle.offsetWidth,height:vEle.offsetHeight,margin:this.view.scale.margin});if(this.state.view.scale==0)this.state.view.scale=.15;if(this.view.scale.lock)this.state.view.autoScale=true;}
var ps=this.data.scaleToPageSize(this.state.view.scale);var w=vEle.offsetWidth;var h=vEle.offsetHeight;var pw=Math.min(ps.width,w);var ph=Math.min(ps.height,h);var maxOffX=0;var maxOffY=0;if(ps.width>w)maxOffX=(ps.width-w)*ps.dpp;if(ps.height>h)maxOffY=(ps.height-h)*ps.dpp;this.state.view.offset.x=Math.min(this.state.view.offset.x,maxOffX);this.state.view.offset.y=Math.min(this.state.view.offset.y,maxOffY);var vpOff=this.view.page.offset;this._vpEle.style.width=(pw)+'px';this._vpEle.style.height=(ph)+'px';this._vpEle.style.left=(((w-pw)/2)-vpOff)+'px';this._vpEle.style.top=(((h-ph)/2)-vpOff)+'px';this._vnpEle.style.left=(0-vpOff)+'px';this._vnpEle.style.top=(0-vpOff)+'px';this._vcEle.width=pw;this._vcEle.height=ph;this.state.view.width=w;this.state.view.height=h;if(this.layout=='view'||(this.layout=='split'&&this.split.layout=='view')){this.state.editor.width=w;this.state.editor.height=h;}
this._repaintView();}},_offset:function(p,x,y){if(p=='editor'){this.state.editor.offset.x=Math.max(Math.min(x,Math.floor(this.data._maxX-(this.state.editor.width/this.state.editor.scale))),0);this.state.editor.offset.y=Math.max(Math.min(y,Math.floor(this.data._maxY-(this.state.editor.height/this.state.editor.scale))),0);}else{this.state.view.offset.x=Math.max(Math.min(x,Math.floor(this.data._maxX-(this.state.view.width/this.state.view.scale))),0);this.state.view.offset.y=Math.max(Math.min(y,Math.floor(this.data._maxY-(this.state.view.height/this.state.view.scale))),0);}},_startPageNav:function(p){if(p=='editor'&&!this._eNav){this._renderNavPage('editor',this.state.editor.scale,-this.state.editor.offset.x,-this.state.editor.offset.y);this._enpEle.style.display='';this._epEle.style.display='none';this._eNav=true;}else if(!this._vNav){this._renderNavPage('view',this.state.view.scale,-this.state.view.offset.x,-this.state.view.offset.y);this._vnpEle.style.display='';this._vpEle.style.display='none';this._vNav=true;}},_endPageNav:function(p){if(p=='editor'&&this._eNav){this._enpEle.style.display='none';this._enpEle.firstChild.style.backgroundImage='';this._epEle.style.display='';this._eNav=false;}else if(this._vNav){this._vnpEle.style.display='none';this._vnpEle.firstChild.style.backgroundImage='';this._vpEle.style.display='';this._vNav=false;}},_repaint:function(){this._repaintEditor();this._repaintView();},_repaintEditor:function(){if(this._eNav){if(this.layout!='view'&&!(this.layout=='split'&&this.split.layout=='view')){this._updateNavPage('editor',this.state.editor.scale,-this.state.editor.offset.x,-this.state.editor.offset.y);}}else{if(this.layout!='view'&&!(this.layout=='split'&&this.split.layout=='view')){if(this.data.page.background.image){this._epbEle.style.left=((0-this.state.editor.offset.x)*this.state.editor.scale)+'px';this._epbEle.style.top=((0-this.state.editor.offset.y)*this.state.editor.scale)+'px';var ps=this.data.scaleToPageSize(this.state.editor.scale);this._epbEle.style.width=ps.width+'px';this._epbEle.style.height=ps.height+'px';if(typeof this.data.page.background.image.size=='object'){this._epbEle.style.backgroundSize=(this.state.editor.scale*this.data.page.background.image.size.width)+'px '+(this.state.editor.scale*this.data.page.background.image.size.height)+'px';}}
this.data.renderRect({x:0,y:0,w:this._bcEle.width,h:this._bcEle.height},{editing:true,scale:this.state.editor.scale,offset:{x:-this.state.editor.offset.x,y:-this.state.editor.offset.y}},this._bcCtx);}
if(this.autoCommit)this.commit();}},_repaintView:function(){if(this._vNav){if(this.layout!='editor'&&!(this.layout=='split'&&this.split.layout=='editor')){this._updateNavPage('view',this.state.view.scale,-this.state.view.offset.x,-this.state.view.offset.y);}}else{if(this.layout!='editor'&&!(this.layout=='split'&&this.split.layout=='editor')){var ps=this.data.scaleToPageSize(this.state.view.scale);if(this.data.page.background.image){this._vpbEle.style.left=((0-this.state.view.offset.x)*this.state.view.scale)+'px';this._vpbEle.style.top=((0-this.state.view.offset.y)*this.state.view.scale)+'px';this._vpbEle.style.width=ps.width+'px';this._vpbEle.style.height=ps.height+'px';if(typeof this.data.page.background.image.size=='object'){this._vpbEle.style.backgroundSize=(this.state.view.scale*this.data.page.background.image.size.width)+'px '+(this.state.view.scale*this.data.page.background.image.size.height)+'px';}}
this.data.renderRect({x:0,y:0,w:this._vcEle.width,h:this._vcEle.height},{editing:true,scale:this.state.view.scale,offset:{x:-this.state.view.offset.x,y:-this.state.view.offset.y}},this._vcCtx);this._vzbEle.style.left=((this.state.editor.offset.x*this.state.view.scale)-(this.state.view.offset.x*this.state.view.scale))+'px';this._vzbEle.style.top=((this.state.editor.offset.y*this.state.view.scale)-(this.state.view.offset.y*this.state.view.scale))+'px';this._vzbEle.style.width=(Math.min(((this.state.editor.width/this.state.editor.scale)*this.state.view.scale),ps.width)-(this.view.page.offset*2))+'px';this._vzbEle.style.height=(Math.min(((this.state.editor.height/this.state.editor.scale)*this.state.view.scale),ps.height)-(this.view.page.offset*2))+'px';}}},_renderNavPage:function(t,s,x,y){var m=this.previewSize;var s2=this.data.zoomToScale({fit:'both',width:m,height:m});var ps=this.data.scaleToPageSize(s2);if(t[0]=='v'){var ele=this._vnpEle;this._vnpScale=this.data._maxX/ps.width;ele.firstChild.innerHTML='<div class="'+this.view.zoomBox.navigateClassName+'" style="position: absolute; top: '+(this.state.editor.offset.y*s2)+'px; left: '+(this.state.editor.offset.x*s2)+'px; width: '+(this.state.editor.width*s2/this.state.editor.scale)+'px; height: '+(this.state.editor.height*s2/this.state.editor.scale)+'px;"></div>'}else{var ele=this._enpEle;this._enpScale=this.data._maxX/ps.width;}
var bgImg=this.data.renderImage('png',ps.width,ps.height);ele.style.width=ps.width+'px';ele.style.height=ps.height+'px';if(this.data.page.background.image){ele.style.backgroundImage='url('+this.data.page.background.image.data+')';if(typeof this.data.page.background.image.size=='object')ele.style.backgroundSize=(s2*this.data.page.background.image.size.width)+'px '+(s2*this.data.page.background.image.size.height)+'px';else ele.style.backgroundSize=this.data.page.background.image.size;ele.style.backgroundPosition=this.data.page.background.image.position;ele.style.backgroundColor=this.data.page.background.color;}else ele.style.backgroundImage='';ele.firstChild.style.backgroundImage='url('+bgImg+')';ele.firstChild.style.backgroundSize='';this._updateNavPage(t,s,x,y);},_updateNavPage:function(t,s,x,y){var x=x*s;var y=y*s;if(t[0]=='v'){var ele=this._vnpEle;var s2=s*this._vnpScale;var w=this.state.view.width;var h=this.state.view.height;}else{var ele=this._enpEle;var s2=s*this._enpScale;var w=this.state.editor.width;var h=this.state.editor.height;}
var ps=this.data.scaleToPageSize(s);if(ps.width<w)x=(w-ps.width)/2;if(ps.height<h)y=(h-ps.height)/2;ele.style[A5.u.css.properties.transformDOM]='translate('+x+'px,'+y+'px) scale('+s2+','+s2+')';},_render:function(){var cEle=$(this.contId);cEle.style.overflow='hidden';cEle.style.cursor='default';if(cEle.style.position!='absolute')cEle.style.position='relative';this._bindEvents(cEle);var vEle=document.createElement('div');vEle.id=this.contId+'.VIEW';vEle.className=this.view.className;$ss(vEle,'position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px; overflow: hidden;');this._vpEle=document.createElement('div');this._vpEle.id=this.contId+'.VIEW.PAGE';this._vpEle.className=this.view.page.className;$ss(this._vpEle,'position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; overflow: hidden;');vEle.appendChild(this._vpEle);this._vnpEle=document.createElement('div');this._vnpEle.id=this.contId+'.VIEW.NAVPAGE';this._vnpEle.className=this.view.page.className;$ss(this._vnpEle,'display: none; position: absolute; top: 0px; left: 0px; overflow: hidden; -ms-transform-origin: left top 0; -webkit-transform-origin: left top 0; transform-origin: left top 0; background-repeat: no-repeat;');this._vnpEle.innerHTML='<div style="position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px;"></div>';vEle.appendChild(this._vnpEle);this._vpbEle=document.createElement('div');this._vpbEle.id=this.contId+'.VIEW.BACKGROUND';$ss(this._vpbEle,'display: none; position: absolute; top: 0px; left: 0px; background-repeat: no-repeat;');this._vpEle.appendChild(this._vpbEle);this._vcEle=document.createElement('canvas');this._vcCtx=this._vcEle.getContext("2d");this._vcEle.id=this.contId+'.VIEW.CANVAS';$ss(this._vcEle,'position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px; width: 100%; height: 100%;');this._vpEle.appendChild(this._vcEle);cEle.appendChild(vEle);this._vzbEle=document.createElement('div');this._vzbEle.id=this.contId+'.VIEW.ZOOMBOX';this._vzbEle.className=this.view.zoomBox.className+$if(this.view.zoomBox.scale.allow,' '+this.view.zoomBox.scale.className,'');$ss(this._vzbEle,'position: absolute; top: 0px; left: 0px; width: 100px; height: 100px;');this._vpEle.appendChild(this._vzbEle);var voEle=document.createElement('div');voEle.id=this.contId+'.VIEW.OVERLAY';voEle.innerHTML=this.view.overlay.html.replace(/\{id\}/gi,this.contId);$ss(voEle,'position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px;');if(!this.view.overlay.show)voEle.style.display='none';vEle.appendChild(voEle);if(this.layout=='detached-view'){var dvEle=$(this.view.detached.id);if(dvEle){dvEle.appendChild(vEle);if(dvEle.style.position!='absolute')dvEle.style.position='relative';this._bindEvents(dvEle);this.state.view.detached=true;}else{this.layout=='split';cEle.appendChild(vEle);}}else cEle.appendChild(vEle);var eEle=document.createElement('div');eEle.id=this.contId+'.EDITOR';eEle.className=this.editor.className;$ss(eEle,'position: absolute; top: 0px; left: 0px; right: 0px;  bottom: 0px; overflow: hidden;');this._epEle=document.createElement('div');this._epEle.id=this.contId+'.EDITOR.PAGE';this._epEle.className=this.editor.page.className;$ss(this._epEle,'position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; overflow: hidden;');eEle.appendChild(this._epEle);this._enpEle=document.createElement('div');this._enpEle.id=this.contId+'.EDITOR.NAVPAGE';this._enpEle.className=this.editor.page.className;$ss(this._enpEle,'display: none; position: absolute; top: 0px; left: 0px; overflow: hidden; -ms-transform-origin: left top 0; -webkit-transform-origin: left top 0; transform-origin: left top 0; background-repeat: no-repeat;');this._enpEle.innerHTML='<div style="position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px;"></div>';eEle.appendChild(this._enpEle);this._epbEle=document.createElement('div');this._epbEle.id=this.contId+'.EDITOR.BACKGROUND';$ss(this._epbEle,'display: none; position: absolute; top: 0px; left: 0px; background-repeat: no-repeat;');this._epEle.appendChild(this._epbEle);this._bcEle=document.createElement('canvas');this._bcCtx=this._bcEle.getContext('2d');$ss(this._bcEle,'position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px; width: 100%; height: 100%;');this._epEle.appendChild(this._bcEle);this._fcEle=document.createElement('canvas');this._fcCtx=this._fcEle.getContext('2d');$ss(this._fcEle,'position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px; width: 100%; height: 100%;');this._epEle.appendChild(this._fcEle);this._eeEle=document.createElement('div');$ss(this._eeEle,'position: absolute; top: 0px; bottom: 0px; width: 50px; height: 50px; display: none;');this._eeEle.className=this.tools.eraser.areaClassName;this._epEle.appendChild(this._eeEle);var eoEle=document.createElement('div');eoEle.id=this.contId+'.EDITOR.OVERLAY';eoEle.innerHTML=this.editor.overlay.html.replace(/\{id\}/gi,this.contId);$ss(eoEle,'position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px;');if(!this.editor.overlay.show)eoEle.style.display='none';eEle.appendChild(eoEle);cEle.appendChild(eEle);this._sEle=$(this.contId+'.STATUS');this._ppEle=$(this.contId+'.PENPREVIEW');this.setStatus();this.setPen(this.tools.pen.base);this._resize();},_bindEvents:function(cEle){A5.u.pointerTracker.add(cEle,{ink:this,gOff:function(id,ele){var xo=0;var yo=0;var sa='';while(ele){sa=$ga(ele,'A5CustomScroll');;if(sa){sa=sa.split(',');xo+=Number(sa[0]);yo+=Number(sa[1]);}
xo-=ele.offsetLeft;yo-=ele.offsetTop;ele=ele.offsetParent;}
xo+=document.body.scrollLeft||document.documentElement.scrollLeft;yo+=document.body.scrollTop||document.documentElement.scrollTop;id.xo=xo;id.yo=yo;},onStart:function(id,od,e){var ele=document.elementFromPoint(id.x,id.y);if(!ele)return false;id.activePart='';id.viewPart='';id.item=false;id.itemArgs='';id.itemArgs='';id.itemObj=false;id.itemEle=false;var item='';while(ele!=this&&ele!=document.body){if(!id.item){item=$ga(ele,'a5-item');if(item!=''&&item!=null){item=item.split(':');id.item=item.shift();id.itemArgs=item.join(':');if(od.ink.items[id.item])id.itemObj=od.ink.items[id.item];id.itemEle=ele;}}
if(ele.id==od.ink.contId+'.VIEW')id.activePart='view';else if(ele.id==od.ink.contId+'.EDITOR')id.activePart='editor';ele=ele.parentNode;}
if(!id.item){if(id.activePart=='editor')od.gOff(id,od.ink._fcEle);else od.gOff(id,od.ink._vcEle);}},onSingleStart:function(id,od,e){if(!id.item){var xy={x:id.x+id.xo,y:id.y+id.yo};if(id.activePart=='editor'){id.preventAdd=true;if(od.ink.state.tool.type=='eraser'){od.ink._eeEle.style.left=(xy.x-(od.ink.tools.eraser.size/2))+'px';od.ink._eeEle.style.top=(xy.y-(od.ink.tools.eraser.size/2))+'px';od.ink._eeEle.style.width=od.ink.tools.eraser.size+'px';od.ink._eeEle.style.height=od.ink.tools.eraser.size+'px';od.ink._eeEle.style.display='';id.cOff=((od.ink.data.state.stroke.maxWidth*od.ink.state.editor.scale)/1.5)+2;id.ensf=od.ink.data.erasePoints(xy.x/od.ink.state.editor.scale-od.ink.state.editor.offset.x,xy.y/od.ink.state.editor.scale-od.ink.state.editor.offset.y,od.ink.tools.eraser.size/od.ink.state.editor.scale,0);}else if(od.ink.state.tool.type=='pan'){id._startX=od.ink.state.editor.offset.x;id._startY=od.ink.state.editor.offset.y;od.ink._startPageNav(id.activePart);}else if(od.ink.state.tool.type=='draw-shape'){id.cOff=(od.ink.data.state.stroke.activeWidth*od.ink.state.editor.scale)+20;id.sxy=xy;var pattr=od.ink.data.attrs[od.ink.data._cAttr].vals;var sWidth=pattr.width*od.ink.state.editor.scale;if(sWidth<1)sWidth=1;if(sWidth>500)sWidth=500;od.ink._fcCtx.lineWidth=sWidth;od.ink._fcCtx.strokeStyle=pattr.color;od.ink._fcCtx.lineCap=pattr.lineCap;id._shape=false;id._shapeSet=false;if(od.ink.state.tool.settings){id._shapeSet=od.ink.state.tool.settings;if(id._shapeSet.shape){if(A5.ink.shapes[id._shapeSet.shape]){id._shape=A5.ink.shapes[id._shapeSet.shape];}}}}else{od.ink.data.startStroke(xy.x/od.ink.state.editor.scale+od.ink.state.editor.offset.x,xy.y/od.ink.state.editor.scale+od.ink.state.editor.offset.y);id.cOff=(od.ink.data.state.stroke.activeWidth*od.ink.state.editor.scale)+2;id.lxy=xy;od.ink.data.renderRect({x:xy.x-id.cOff,y:xy.y-id.cOff,w:(id.cOff*2),h:(id.cOff*2)},{editing:true,showPageLines:false,scale:od.ink.state.editor.scale,stroke:{first:od.ink.data._cStroke,last:od.ink.data._cStroke},offset:{x:-od.ink.state.editor.offset.x,y:-od.ink.state.editor.offset.y}},od.ink._fcCtx);}}else if(id.activePart=='view'){var zbx=od.ink._vzbEle.offsetLeft;var zby=od.ink._vzbEle.offsetTop;var zbow=od.ink._vzbEle.offsetWidth;var zboh=od.ink._vzbEle.offsetHeight;var zbw=Math.max(42,zbow);var zbh=Math.max(42,zboh);zbxc=zbx-(zbw/2)+(zbow/2);zbyc=zby-(zbh/2)+(zboh/2);var zbs=false;if(od.ink.view.zoomBox.scale.allow){id._startX=od.ink.state.editor.offset.x;id._startY=od.ink.state.editor.offset.y;id._
if(od.ink.view.zoomBox.scale.from=='top-left'){if(xy.x>=zbx-22&&xy.x<=zbx+22&&xy.y>=zby-22&&xy.y<=zby+22){zbs=true;id._startX=od.ink.state.editor.offset.x+(od.ink.state.editor.width/od.ink.state.editor.scale);id._startY=od.ink.state.editor.offset.y+(od.ink.state.editor.height/od.ink.state.editor.scale);}}else if(od.ink.view.zoomBox.scale.from=='top-right'){if(xy.x>=zbx+zbow-22&&xy.x<=zbx+zbow+22&&xy.y>=zby-22&&xy.y<=zby+22){zbs=true;id._startY=od.ink.state.editor.offset.y+(od.ink.state.editor.height/od.ink.state.editor.scale);}}else if(od.ink.view.zoomBox.scale.from=='bottom-left'){if(xy.x>=zbx-22&&xy.x<=zbx+22&&xy.y>=zby+zboh-22&&xy.y<=zby+zboh+22){zbs=true;id._startX=od.ink.state.editor.offset.x+(od.ink.state.editor.width/od.ink.state.editor.scale);}}else{if(xy.x>=zbx+zbow-22&&xy.x<=zbx+zbow+22&&xy.y>=zby+zboh-22&&xy.y<=zby+zboh+22)zbs=true;}}
if(zbs){var noScale=false;if(od.ink.state.editor.autoScale){if(od.ink.editor.scale.lock)noScale=true;}
if(noScale){id.viewPart='view';id._panActive=false;}else{od.ink.editor.scale=false;id.viewPart='zoombox-scale';id._startZBW=zbow;id._startZBH=zboh;od.ink._startPageNav('editor');}}else if(xy.x>=zbxc&&xy.x<=zbxc+zbw&&xy.y>=zbyc&&xy.y<=zbyc+zbh){id.viewPart='zoombox-move';id._startX=od.ink.state.editor.offset.x;id._startY=od.ink.state.editor.offset.y;od.ink._startPageNav('editor');}else{id.viewPart='view';id._panActive=false;}}}else{id.preventAdd=true;id._d={c:false,a:false,t:'',inc:{a:'n',x:0,y:0,n:0,oy:0,ox:0},md:0,sx:0,sy:0,isx:0,isy:0,ss:15,s:20};if(id.item=='*navigate'&&id.itemArgs=='new-line'){id._d.c=true;id._d.t='pan-line';od.ink.setStatus('item:navigate:new-line');}else if(id.item=='*navigate'||(id.item=='*pan'&&id.itemArgs=='immediate')){id._d.c=true;id._d.t='pan';od.ink.setStatus('item:navigate');}else if(id.item=='*undo'||id.item=='*redo'){id._d.c=true;id._d.t=id.item.substr(1);od.ink.setStatus('item:'+id._d.t);}else if(id.item=='*eraser'){id._d.c=true;id._d.t='eraser';od.ink.setStatus('item:eraser');}}},onDblStart:function(id,od,e){if(!id.item){id.preventAdd=true;if(!id._panActive)od.ink._startPageNav(id.activePart);if(id.activePart=='editor'){id._startScale=od.ink.state.editor.scale;id._startX=od.ink.state.editor.offset.x;id._startY=od.ink.state.editor.offset.y;}else if(id.activePart=='view'){id._startScale=od.ink.state.view.scale;id._startX=od.ink.state.view.offset.x;id._startY=od.ink.state.view.offset.y;}}},onDblEnd:function(id,od,e){if(!id.item){id.preventAdd=false;od.ink._endPageNav(id.activePart);od.ink.refresh();}},onChange:function(id,od,e){if(!id.item){if(id.type=='single'){if(id.activePart=='editor'){var xy={x:id.x+id.xo,y:id.y+id.yo};if(od.ink.state.tool.type=='eraser'){od.ink._eeEle.style.left=(xy.x-(od.ink.tools.eraser.size/2))+'px';od.ink._eeEle.style.top=(xy.y-(od.ink.tools.eraser.size/2))+'px';id.ensf=od.ink.data.erasePoints(xy.x/od.ink.state.editor.scale+od.ink.state.editor.offset.x,xy.y/od.ink.state.editor.scale+od.ink.state.editor.offset.y,od.ink.tools.eraser.size/od.ink.state.editor.scale,id.ensf);od.ink.data.renderRect({x:xy.x-(od.ink.tools.eraser.size/2)-id.cOff,y:xy.y-(od.ink.tools.eraser.size/2)-id.cOff,w:od.ink.tools.eraser.size+(id.cOff*2),h:od.ink.tools.eraser.size+(id.cOff*2)},{editing:true,scale:od.ink.state.editor.scale,offset:{x:-od.ink.state.editor.offset.x,y:-od.ink.state.editor.offset.y}},od.ink._bcCtx);}else if(od.ink.state.tool.type=='pan'){od.ink._offset('editor',id._startX-(id.delta.x/od.ink.state.editor.scale),id._startY-(id.delta.y/od.ink.state.editor.scale));od.ink._repaintEditor();od.ink._vzbEle.style.left=((od.ink.state.editor.offset.x*od.ink.state.view.scale)-(od.ink.state.view.offset.x*od.ink.state.view.scale))+'px';od.ink._vzbEle.style.top=((od.ink.state.editor.offset.y*od.ink.state.view.scale)-(od.ink.state.view.offset.y*od.ink.state.view.scale))+'px';}else if(od.ink.state.tool.type=='draw-shape'){od.ink._fcCtx.beginPath();od.ink._fcCtx.clearRect(0,0,od.ink._fcEle.width,od.ink._fcEle.height);if(id._shape){id._shape.draw({startX:id.sxy.x,startY:id.sxy.y,endX:xy.x,endY:xy.y},id._shapeSet,od.ink.data,od.ink._fcCtx);}}else{if(Math.abs(id.lxy.x-xy.x)>od.ink.tools.pen.smooth||Math.abs(id.lxy.y-xy.y)>od.ink.tools.pen.smooth){id.lxy=xy;od.ink.data.addToStroke(xy.x/od.ink.state.editor.scale+od.ink.state.editor.offset.x,xy.y/od.ink.state.editor.scale+od.ink.state.editor.offset.y);od.ink.data.renderRect({x:id.start.x+id.xo+id.delta.min.x-id.cOff,y:id.start.y+id.yo+id.delta.min.y-id.cOff,w:id.delta.max.x-id.delta.min.x+(id.cOff*2),h:id.delta.max.y-id.delta.min.y+(id.cOff*2)},{editing:true,showPageLines:false,scale:od.ink.state.editor.scale,stroke:{first:od.ink.data._cStroke,last:od.ink.data._cStroke},offset:{x:-od.ink.state.editor.offset.x,y:-od.ink.state.editor.offset.y}},od.ink._fcCtx);}}}else if(id.activePart=='view'){if(id.viewPart=='zoombox-scale'){if(od.ink.view.zoomBox.scale.from=='top-left'){od.ink.state.editor.scale=Math.max(Math.min(od.ink.state.editor.width/(((id._startZBW-id.delta.x)/od.ink.state.view.scale)),od.ink.state.editor.height/(((id._startZBH-id.delta.y)/od.ink.state.view.scale))),.05);od.ink._offset('editor',id._startX-(od.ink.state.editor.width/od.ink.state.editor.scale),id._startY-(od.ink.state.editor.height/od.ink.state.editor.scale));}else if(od.ink.view.zoomBox.scale.from=='top-right'){od.ink.state.editor.scale=Math.max(Math.min(od.ink.state.editor.width/(((id._startZBW+id.delta.x)/od.ink.state.view.scale)),od.ink.state.editor.height/(((id._startZBH-id.delta.y)/od.ink.state.view.scale))),.05);od.ink._offset('editor',id._startX,id._startY-(od.ink.state.editor.height/od.ink.state.editor.scale));}else if(od.ink.view.zoomBox.scale.from=='bottom-left'){od.ink.state.editor.scale=Math.max(Math.min(od.ink.state.editor.width/(((id._startZBW-id.delta.x)/od.ink.state.view.scale)),od.ink.state.editor.height/(((id._startZBH+id.delta.y)/od.ink.state.view.scale))),.05);od.ink._offset('editor',id._startX-(od.ink.state.editor.width/od.ink.state.editor.scale),id._startY);}else{od.ink.state.editor.scale=Math.max(Math.min(od.ink.state.editor.width/(((id._startZBW+id.delta.x)/od.ink.state.view.scale)),od.ink.state.editor.height/(((id._startZBH+id.delta.y)/od.ink.state.view.scale))),.05);}
od.ink._vzbEle.style.left=((od.ink.state.editor.offset.x*od.ink.state.view.scale)-(od.ink.state.view.offset.x*od.ink.state.view.scale))+'px';od.ink._vzbEle.style.top=((od.ink.state.editor.offset.y*od.ink.state.view.scale)-(od.ink.state.view.offset.y*od.ink.state.view.scale))+'px';od.ink._vzbEle.style.width=(((od.ink.state.editor.width/od.ink.state.editor.scale)*od.ink.state.view.scale)-1)+'px';od.ink._vzbEle.style.height=(((od.ink.state.editor.height/od.ink.state.editor.scale)*od.ink.state.view.scale)-2)+'px';od.ink._repaintEditor();}else if(id.viewPart=='zoombox-move'){od.ink._offset('editor',((id._startX*od.ink.state.view.scale)+id.delta.x)/od.ink.state.view.scale,((id._startY*od.ink.state.view.scale)+id.delta.y)/od.ink.state.view.scale);od.ink._vzbEle.style.left=((od.ink.state.editor.offset.x*od.ink.state.view.scale)-(od.ink.state.view.offset.x*od.ink.state.view.scale))+'px';od.ink._vzbEle.style.top=((od.ink.state.editor.offset.y*od.ink.state.view.scale)-(od.ink.state.view.offset.y*od.ink.state.view.scale))+'px';od.ink._repaintEditor();}else if(id.viewPart=='view'){if(id._panActive){od.ink._offset('view',id._startX-(id.delta.x/od.ink.state.view.scale),id._startY-(id.delta.y/od.ink.state.view.scale));od.ink._repaintView();}else if(Math.abs(id.delta.x)>5||Math.abs(id.delta.y)>5){id._panActive=true;od.ink._startPageNav(id.activePart);id._startX=od.ink.state.view.offset.x+(id.delta.x/od.ink.state.view.scale);id._startY=od.ink.state.view.offset.y+(id.delta.x/od.ink.state.view.scale);}}}}else if(id.type=='double'){if(id.activePart=='editor'){if(!od.ink.state.editor.autoScale){od.ink.editor.scale=false;od.ink.state.editor.scale=Math.max((id._startScale*id.scale.value),.05);}
od.ink._offset('editor',id._startX-(id.delta.x/od.ink.state.editor.scale),id._startY-(id.delta.y/od.ink.state.editor.scale));od.ink._repaintEditor();}else if(id.activePart=='view'){if(!od.ink.state.view.autoScale){od.ink.view.scale=false;od.ink.state.view.scale=Math.max((id._startScale*id.scale.value),.05);}
od.ink._offset('view',id._startX-(id.delta.x/od.ink.state.view.scale),id._startY-(id.delta.y/od.ink.state.view.scale));od.ink._repaintView();}}}else{if(id._d.c){if(id._d.a){if(id._d.t=='pan'){if(id.activePart=='editor'){od.ink._offset('editor',id._d.isx-(id.delta.x/od.ink.state.editor.scale),id._d.isy-(id.delta.y/od.ink.state.editor.scale));od.ink._repaintEditor();od.ink._vzbEle.style.left=((od.ink.state.editor.offset.x*od.ink.state.view.scale)-(od.ink.state.view.offset.x*od.ink.state.view.scale))+'px';od.ink._vzbEle.style.top=((od.ink.state.editor.offset.y*od.ink.state.view.scale)-(od.ink.state.view.offset.y*od.ink.state.view.scale))+'px';}else if(id.activePart=='view'){od.ink._offset('view',id._d.isx-(id.delta.x/od.ink.state.view.scale),id._d.isy-(id.delta.y/od.ink.state.view.scale));od.ink._repaintView();}}else if(id._d.t=='eraser'){if(Math.abs(id.delta.x-id._d.sx)>Math.abs(id.delta.y-id._d.sy))id._d.md=id.delta.x-id._d.sx;else id._d.md=id.delta.y-id._d.sy;var es=Math.max(Math.min(id._d.md+od.ink.tools.eraser.size,od.ink.tools.eraser.max),od.ink.tools.eraser.min);od.ink._eeEle.style.left=((od.ink.state.editor.width/2)-(es/2))+'px';od.ink._eeEle.style.top=((od.ink.state.editor.height/2)-(es/2))+'px';od.ink._eeEle.style.width=es+'px';od.ink._eeEle.style.height=es+'px';od.ink._eeEle.style.display='';}else{if(Math.abs(id.delta.x-id._d.inc.ox)>=id._d.s){if(id.delta.x<id._d.inc.ox)id._d.inc.x=-1;else id._d.inc.x=1;id._d.inc.ox=id.delta.x;id._d.inc.a='x';}else if(Math.abs(id.delta.y-id._d.inc.oy)>=id._d.s){if(id.delta.y<id._d.inc.oy)id._d.inc.y=-1;else id._d.inc.y=1;id._d.inc.oy=id.delta.y;id._d.inc.a='y';}
if(id._d.t=='pan-line'){if(id._d.inc[id._d.inc.a]==-1)od.ink.navigate(id.activePart,'prev-line');else if(id._d.inc[id._d.inc.a]==1)od.ink.navigate(id.activePart,'next-line');}else if(id._d.t=='undo'||id._d.t=='redo'){if(id._d.inc[id._d.inc.a]==-1)od.ink.undo();else if(id._d.inc[id._d.inc.a]==1)od.ink.redo();}
id._d.inc.a='n';}}else if(Math.abs(id.delta.x)>id._d.ss||Math.abs(id.delta.y)>id._d.ss){id._d.a=true;id._d.sx=id.delta.x;id._d.sy=id.delta.y;id._d.isx=od.ink.state[id.activePart].offset.x+(id.delta.x/od.ink.state[id.activePart].scale);id._d.isy=od.ink.state[id.activePart].offset.y+(id.delta.y/od.ink.state[id.activePart].scale);if(id._d.t=='pan')od.ink._startPageNav(id.activePart);}}}},onEnd:function(id,od,e){od.ink._endPageNav('editor');od.ink._endPageNav('view');od.ink.setStatus();if(!id.item){var xy={x:id.x+id.xo,y:id.y+id.yo};if(id.activePart=='editor'){if(od.ink.state.tool.type=='eraser'){od.ink._repaint();od.ink._eeEle.style.display='none';od.ink._change();}else if(od.ink.state.tool.type=='pan'){od.ink._repaint();}else if(od.ink.state.tool.type=='draw-shape'){if(id._shape){id._shape.commit({startX:id.sxy.x/od.ink.state.editor.scale+od.ink.state.editor.offset.x,startY:id.sxy.y/od.ink.state.editor.scale+od.ink.state.editor.offset.y,endX:xy.x/od.ink.state.editor.scale+od.ink.state.editor.offset.x,endY:xy.y/od.ink.state.editor.scale+od.ink.state.editor.offset.y},id._shapeSet,od.ink.data);}
od.ink._fcCtx.beginPath();od.ink._fcCtx.clearRect(0,0,od.ink._fcEle.width,od.ink._fcEle.height);od.ink._fcCtx.stroke();od.ink._repaint();od.ink._change();}else{od.ink._fcCtx.beginPath();od.ink._fcCtx.clearRect(0,0,od.ink._fcEle.width,od.ink._fcEle.height);od.ink._fcCtx.stroke();od.ink.data.endStroke(xy.x/od.ink.state.editor.scale+od.ink.state.editor.offset.x,xy.y/od.ink.state.editor.scale+od.ink.state.editor.offset.y);od.ink._repaint();od.ink._change();}
if(!od.ink.state.tool.sticky)od.ink.setTool('pen');}else if(id.activePart=='view'){if(id.viewPart=='zoombox-scale'||id.viewPart=='zoombox-move'){od.ink._resize();}else if(id.viewPart=='view'){if(id.captured==1&&id.delta.max.x<15&&id.delta.max.y<15&&id.delta.min.x>-15&&id.delta.min.y>-15){od.ink._offset('editor',od.ink.state.view.offset.x+(xy.x/od.ink.state.view.scale)-(od.ink.state.editor.width/2),od.ink.state.view.offset.y+(xy.y/od.ink.state.view.scale)-(od.ink.state.editor.height/2));}
od.ink._repaint();}}}else{if(id._d.a){if(id._d.t=='eraser'){od.ink.tools.eraser.size=Math.max(Math.min(id._d.md+od.ink.tools.eraser.size,od.ink.tools.eraser.max),od.ink.tools.eraser.min);od.ink._eeEle.style.display='none';od.ink.setTool('eraser',id.itemArgs=='sticky');}
od.ink._repaint();}else{var ele=document.elementFromPoint(id.x,id.y);var isClick=false;if(ele){while(ele!=this&&ele!=document.body){if(ele==id.itemEle){isClick=true;break;}
ele=ele.parentNode;}}
if(isClick){if(id.itemObj){if(id.itemObj.onClick)id.itemObj.onClick.call(od.ink,id.itemEle,id.activePart,id);}else{var sticky=id.itemArgs=='sticky';if(id.item=='*undo')od.ink.undo()
else if(id.item=='*redo')od.ink.redo()
else if(id.item=='*eraser'){if(od.ink.state.tool.type!='eraser')od.ink.setTool('eraser',sticky);else od.ink.setTool('pen');}else if(id.item=='*pan'&&id.itemArgs!='immediate'){if(od.ink.state.tool.type!='pan')od.ink.setTool('pan',sticky);else od.ink.setTool('pen');}else if(id.item=='*navigate')od.ink.navigate(id.activePart,id.itemArgs);}}}
id.itemObj=false;id.itemEle=false;}}});$e.add(cEle,'wheel',function(e,ci){var ele=document.elementFromPoint(e.clientX,e.clientY);if(!ele)return false;$e.stopEvent(e);activePart='';while(ele!=this&&ele!=document.body){if(ele.id==ci.contId+'.VIEW'){activePart='view';break;}else if(ele.id==ci.contId+'.EDITOR'){activePart='editor';break;}
ele=ele.parentNode;}
if(activePart=='view'){if(e.ctrlKey){if(ci.state.view.autoScale){if(ci.view.scale.lock)return false;}
ci.view.scale=false;var a=ci.state.view.scale/4;if(e.deltaY>0&&ci.state.view.scale>.05)ci.state.view.scale-=a;else if(e.deltaY<0)ci.state.view.scale+=a;ci._resize();}else if(e.shiftKey){if(e.deltaX>0||e.deltaY>0)ci.navigate('view','nudge-right');else if(e.deltaX<0||e.deltaY<0)ci.navigate('view','nudge-left');}else{if(e.deltaY>0)ci.navigate('view','nudge-down');else if(e.deltaY<0)ci.navigate('view','nudge-up');}}else if(activePart=='editor'){if(e.ctrlKey){if(ci.state.editor.autoScale){if(ci.editor.scale.lock)return false;}
ci.editor.scale=false;var a=ci.state.editor.scale/4;if(e.deltaY>0&&ci.state.editor.scale>.05)ci.state.editor.scale-=a;else if(e.deltaY<0)ci.state.editor.scale+=a;ci._resize();}else if(e.shiftKey){if(e.deltaX>0||e.deltaY>0)ci.navigate('editor','nudge-right');else if(e.deltaX<0||e.deltaY<0)ci.navigate('editor','nudge-left');}else{if(e.deltaY>0)ci.navigate('editor','nudge-down');else if(e.deltaY<0)ci.navigate('editor','nudge-up');}}},this,false,'INK.'+this.contId+'.EVENTS');}});